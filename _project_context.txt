=== PROJECT STRUCTURE ===
app
components
conductor
hooks
lib
public
scripts
types
.env.local
CS1.1.zip
eslint.config.mjs
next-env.d.ts
next.config.ts
package-lock.json
package.json
postcss.config.mjs
README.md
ROADMAP.md
tailwind.config.ts
tsconfig.json
_project_context.txt
app\api
app\dashboard
app\login
app\favicon.ico
app\globals.css
app\layout.tsx
app\page.tsx
app\api\assets
app\api\export
app\api\generate
app\api\ideation
app\api\marketing
app\api\proxy
app\api\settings
app\api\assets\search
app\api\export\[id]
app\api\generate\audio
app\api\generate\batch
app\api\generate\image
app\api\generate\script
app\api\generate\route.ts
app\api\ideation\route.ts
app\api\marketing\route.ts
app\api\proxy\route.ts
app\api\settings\validate
app\dashboard\ideation
app\dashboard\project
app\dashboard\settings
app\dashboard\layout.tsx
app\dashboard\page.tsx
app\dashboard\ideation\page.tsx
app\dashboard\project\[id]
app\dashboard\settings\page.tsx
app\login\page.tsx
components\editor
components\launch
components\layout
components\marketing
components\media
components\modals
components\LaunchPad.tsx
components\MediaSelector.tsx
components\ProjectPlayer.tsx
components\StatusBadge.tsx
components\VideoPlayer.tsx
components\editor\SceneEditor.tsx
components\launch\LaunchPad.tsx
components\layout\Sidebar.tsx
components\marketing\MarketingModal.tsx
components\media\MediaModal.tsx
components\modals\DeleteModal.tsx
conductor\archive
conductor\code_styleguides
conductor\tracks
conductor\index.md
conductor\product-guidelines.md
conductor\product.md
conductor\setup_state.json
conductor\tech-stack.md
conductor\tracks.md
conductor\workflow.md
conductor\archive\create_export_page_20260206
conductor\archive\refine_project_dashboard_20260206
conductor\archive\create_export_page_20260206\index.md
conductor\archive\create_export_page_20260206\metadata.json
conductor\archive\create_export_page_20260206\plan.md
conductor\archive\create_export_page_20260206\spec.md
conductor\archive\refine_project_dashboard_20260206\index.md
conductor\archive\refine_project_dashboard_20260206\metadata.json
conductor\archive\refine_project_dashboard_20260206\plan.md
conductor\archive\refine_project_dashboard_20260206\spec.md
conductor\code_styleguides\javascript.md
conductor\code_styleguides\typescript.md
hooks\useJobStatus.ts
lib\ai
lib\services
lib\types
lib\utils
lib\validations
lib\pillarStatus.ts
lib\supabaseClient.ts
lib\supabaseServer.ts
lib\types.ts
lib\ai\scriptGenerator.ts
lib\services\ai.service.ts
lib\services\asset.service.ts
lib\services\audio.service.ts
lib\services\batch.service.ts
lib\services\cost.service.ts
lib\services\dna.service.ts
lib\services\job.service.ts
lib\services\marketing.service.ts
lib\services\media.service.ts
lib\services\project.service.ts
lib\services\script.service.ts
lib\types\index.ts
lib\utils\retry.ts
lib\validations\schemas.ts
public\file.svg
public\globe.svg
public\next.svg
public\vercel.svg
public\window.svg
scripts\test-asset-engine.ts
scripts\test-audio.ts
scripts\test-export.ts
types\google-tts-api.d.ts


=== FILE: app\api\assets\search\route.ts ===
import { NextResponse } from 'next/server'

export async function POST(req: Request) {
  try {
    const { query, type = 'photos' } = await req.json()
    const results: any[] = []
    const promises = []

    // Check availability
    const hasPexels = !!process.env.PEXELS_API_KEY
    const hasPixabay = !!process.env.PIXABAY_API_KEY
    const hasGiphy = !!process.env.GIPHY_API_KEY
    const hasUnsplash = !!process.env.UNSPLASH_ACCESS_KEY

    // Fallback if no keys exist
    if (!hasPexels && !hasPixabay && !hasGiphy && !hasUnsplash) {
        return NextResponse.json({ results: [{
            id: 'demo-1',
            provider: 'System (No API Keys)',
            type: 'image',
            thumbnail: 'https://via.placeholder.com/640x360?text=Add+API+Keys+in+.env',
            url: 'https://via.placeholder.com/1280x720?text=Add+API+Keys+in+.env',
            author: 'System'
        }]})
    }

    // --- 1. PEXELS SEARCH ---
    if (hasPexels) {
      const endpoint = type === 'videos' ? 'videos/search' : 'v1/search'
      promises.push(
        fetch(`https://api.pexels.com/${endpoint}?query=${query}&per_page=10`, {
          headers: { Authorization: process.env.PEXELS_API_KEY! }
        }).then(async res => {
          const data = await res.json()
          if (type === 'videos') {
            return data.videos?.map((v: any) => ({
              id: `pex-${v.id}`,
              provider: 'Pexels',
              type: 'video',
              thumbnail: v.image,
              url: v.video_files[0].link,
              author: v.user.name
            })) || []
          } else {
            return data.photos?.map((p: any) => ({
              id: `pex-${p.id}`,
              provider: 'Pexels',
              type: 'image',
              thumbnail: p.src.medium,
              url: p.src.original,
              author: p.photographer
            })) || []
          }
        })
      )
    }

    // --- 2. PIXABAY SEARCH ---
    if (hasPixabay) {
      const category = type === 'videos' ? 'video' : 'photo'
      promises.push(
        fetch(`https://pixabay.com/api/${type === 'videos' ? 'videos/' : ''}?key=${process.env.PIXABAY_API_KEY}&q=${query}&image_type=${category}&per_page=10`)
          .then(async res => {
            const data = await res.json()
            if (type === 'videos') {
               return data.hits?.map((v: any) => ({
                id: `pix-${v.id}`,
                provider: 'Pixabay',
                type: 'video',
                thumbnail: v.userImageURL || `https://i.vimeocdn.com/video/${v.picture_id}_295x166.jpg`,
                url: v.videos?.medium?.url || v.videos?.small?.url,
                author: v.user
              })) || []
            } else {
              return data.hits?.map((p: any) => ({
                id: `pix-${p.id}`,
                provider: 'Pixabay',
                type: 'image',
                thumbnail: p.webformatURL,
                url: p.largeImageURL,
                author: p.user
              })) || []
            }
          })
      )
    }

    // --- 3. GIPHY SEARCH (Images Only) ---
    // GIPHY doesn't do "stock video" in the same way, so we only search it if user asks for photos/gifs
    if (hasGiphy && type !== 'videos') {
        promises.push(
          fetch(`https://api.giphy.com/v1/gifs/search?api_key=${process.env.GIPHY_API_KEY}&q=${query}&limit=10&rating=pg`)
            .then(async res => {
              const data = await res.json()
              return data.data?.map((g: any) => ({
                id: `gip-${g.id}`,
                provider: 'GIPHY',
                type: 'image', // We treat GIFs as images for the UI
                thumbnail: g.images.fixed_height.url,
                url: g.images.original.url,
                author: g.username || 'Giphy'
              })) || []
            })
        )
    }

    // --- 4. UNSPLASH SEARCH ---
    if (hasUnsplash && type !== 'videos') {
      promises.push(
        fetch(`https://api.unsplash.com/search/photos?query=${query}&per_page=10&client_id=${process.env.UNSPLASH_ACCESS_KEY}`)
          .then(async res => {
            const data = await res.json()
            return data.results?.map((u: any) => ({
              id: `uns-${u.id}`,
              provider: 'Unsplash',
              type: 'image',
              thumbnail: u.urls.small,
              url: u.urls.regular,
              author: u.user.name
            })) || []
          })
      )
    }

    // Execute all
    const settled = await Promise.allSettled(promises)
    settled.forEach(result => {
      if (result.status === 'fulfilled') {
        results.push(...result.value)
      }
    })

    // Shuffle and return
    return NextResponse.json({ results: results.sort(() => Math.random() - 0.5) })

  } catch (error) {
    console.error('Asset Search Error:', error)
    return NextResponse.json({ error: 'Failed to fetch assets' }, { status: 500 })
  }
}


=== FILE: app\api\export\[id]\route.ts ===
import { NextResponse } from 'next/server'
import { ProjectService } from '@/lib/services/project.service'

export async function POST(
  req: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params
    
    // Use the service to generate the bundle
    const exportData = await ProjectService.exportProjectPackage(id)

    return NextResponse.json({ 
      success: true, 
      data: exportData 
    })

  } catch (error: any) {
    console.error('Export Failed:', error)
    return NextResponse.json({ error: error.message }, { status: 500 })
  }
}


=== FILE: app\api\generate\audio\route.ts ===
import { NextResponse } from 'next/server'
import { supabaseAdmin } from '@/lib/supabaseServer'
import { JobService } from '@/lib/services/job.service'
import { AudioService } from '@/lib/services/audio.service'

export async function POST(req: Request) {
  try {
    const { projectId, userId, keys, model } = await req.json();

    if (!projectId || !userId) {
      return NextResponse.json({ error: 'Missing data' }, { status: 400 });
    }

    // 1. Get scenes that have text to speak
    const { data: scenes } = await supabaseAdmin
      .from('scenes')
      .select('*')
      .eq('project_id', projectId)
      .order('sequence_order', { ascending: true });

    if (!scenes || scenes.length === 0) return NextResponse.json({ error: 'No scenes' }, { status: 404 });

    // 2. Create Job
    const jobId = await JobService.createJob(userId, 'audio_gen');

    // 3. Process Async
    (async () => {
        try {
            let completed = 0;
            for (const scene of scenes) {
                const percent = Math.round((completed / scenes.length) * 100);
                await JobService.updateProgress(jobId, percent, `Generating Voiceover ${scene.sequence_order}/${scenes.length}...`);
                
                // Only generate if there is text
                if (scene.audio_text && scene.audio_text.trim().length > 0) {
                    await AudioService.generateAudio(projectId, scene.id, scene.audio_text, userId, keys, model);
                }
                completed++;
            }
            await JobService.updateProgress(jobId, 100, 'Audio generated.');
        } catch (e: any) {
            console.error('Audio Gen failed:', e);
            await JobService.failJob(jobId, e.message);
        }
    })();

    return NextResponse.json({ success: true, jobId });

  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}


=== FILE: app\api\generate\batch\route.ts ===
import { NextResponse } from 'next/server'
import { supabaseAdmin } from '@/lib/supabaseServer'
import { JobService } from '@/lib/services/job.service'
import { AssetService } from '@/lib/services/asset.service'

export async function POST(req: Request) {
  try {
    // Read parameters
    const { projectId, userId, keys, model } = await req.json();

    if (!projectId || !userId) {
      return NextResponse.json({ error: 'Missing data' }, { status: 400 });
    }

    // 1. Get all scenes for project
    const { data: scenes } = await supabaseAdmin
      .from('scenes')
      .select('*')
      .eq('project_id', projectId)
      .order('sequence_order', { ascending: true });

    if (!scenes || scenes.length === 0) {
      return NextResponse.json({ error: 'No scenes found' }, { status: 404 });
    }

    // 2. Create Job (FIXED TYPO: 'asset_batch')
    const jobId = await JobService.createJob(userId, 'asset_batch');

    // 3. Start Async Processing
    (async () => {
        try {
            let completed = 0;
            for (const scene of scenes) {
                const percent = Math.round((completed / scenes.length) * 100);
                await JobService.updateProgress(jobId, percent, `Processing Scene ${scene.sequence_order}/${scenes.length}...`);
                
                // Pass the 'model' down to the service
                await AssetService.generateAsset(projectId, scene.id, scene.visual_description, userId, keys, model);
                completed++;
            }
            await JobService.updateProgress(jobId, 100, 'Visuals generated.');
        } catch (e: any) {
            console.error('Batch failed:', e);
            await JobService.failJob(jobId, e.message);
        }
    })();

    return NextResponse.json({ success: true, jobId });

  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}


=== FILE: app\api\generate\image\route.ts ===
import { NextResponse } from 'next/server'

export async function POST(req: Request) {
  try {
    const { prompt } = await req.json()

    // PEXELS API (Free Stock Photos)
    // We search for the prompt term to get a relevant real-world image.
    // If you have a Pexels API Key, add it to your .env as PEXELS_API_KEY.
    // If not, this code falls back to a public search or placeholder which is still better than a crash.
    
    // For now, we will use a "Keyword-based" placeholder service that is 100% free and requires NO key.
    // Unsplash Source is deprecated, so we use 'Pollinations' in a different way: 
    // We ask it to "Imagine" the stock photo (it's still AI, but we use the simple link method which worked earlier for the Roman Shield).
    
    // Since we know the "Simple Link" method (Scenario B from earlier) worked to SHOW the image,
    // but failed to SAVE it due to CORS...
    // We will just return the URL and let the frontend save it as a "External Link" instead of trying to upload it.
    
    const seed = Math.floor(Math.random() * 1000)
    const encodedPrompt = encodeURIComponent(prompt)
    const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1280&height=720&seed=${seed}&nologo=true&model=flux`

    // We return isBase64: false so the frontend treats it as a URL
    return NextResponse.json({ 
        url: imageUrl, 
        isBase64: false 
    })

  } catch (error: any) {
    console.error('Stock Photo Error:', error)
    return NextResponse.json({ error: 'Failed to find image' }, { status: 500 })
  }
}


=== FILE: app\api\generate\script\route.ts ===
import { NextResponse } from 'next/server'
import { ScriptService } from '@/lib/services/script.service'
import { JobService } from '@/lib/services/job.service'

export async function POST(req: Request) {
  try {
    const { projectId, title, context, userId, keys, model } = await req.json();

    if (!projectId || !userId) {
      return NextResponse.json({ error: 'Missing projectId or userId' }, { status: 400 });
    }

    const jobId = await JobService.createJob(userId, 'script_gen');

    (async () => {
      try {
        await JobService.updateProgress(jobId, 10, `Initializing ${model || 'Free'} Engine...`);
        // We now pass the specific model selected by the user
        await ScriptService.generateScript(projectId, title, context, keys, model);
        await JobService.updateProgress(jobId, 100, 'Script generated.');
      } catch (error: any) {
        console.error('Script Gen Failed:', error);
        await JobService.failJob(jobId, error.message);
      }
    })();

    return NextResponse.json({ success: true, jobId, message: 'Started' });

  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}


=== FILE: app\api\generate\route.ts ===
import { NextResponse } from 'next/server'

export async function POST(req: Request) {
  try {
    const { prompt } = await req.json()
    const apiKey = process.env.GEMINI_API_KEY

    if (!apiKey) {
        return NextResponse.json({ 
            data: [{ audio: "Error: No API Key.", visual: "Check .env.local", type: "Stock Video" }] 
        })
    }

    // UPDATED MODEL: Using 'gemini-2.5-flash' from your list.
    // This is the specific model ID for the version you have access to.
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`

    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `
              You are a JSON generator. 
              Topic: ${prompt}
              Output: A raw JSON array of 3 objects.
              Keys: "audio", "visual", "type".
              NO Markdown. NO code blocks.
              Example: [{"audio":"Hi","visual":"Wave","type":"Stock Video"}]
            `
          }]
        }]
      })
    })

    if (!response.ok) {
        // If 2.5 fails, we automatically fallback to 2.0 (just in case)
        if (response.status === 404) {
             console.log("Gemini 2.5 not found, trying 2.0...")
             return fallbackToGemini2(prompt, apiKey)
        }
        const errorText = await response.text()
        throw new Error(`Google API Error: ${response.status} - ${errorText}`)
    }

    const data = await response.json()
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || ""

    // CLEANER (Extract the JSON)
    const start = text.indexOf('[')
    const end = text.lastIndexOf(']') + 1

    if (start !== -1 && end > start) {
        const jsonStr = text.slice(start, end)
        return NextResponse.json({ data: JSON.parse(jsonStr) })
    }

    throw new Error("No JSON array found in response")

  } catch (error: any) {
    console.error("Script Gen Error:", error)
    return NextResponse.json({ 
        data: [
            { audio: "Script generation hit a bump.", visual: "Glitch Art", type: "Stock Video" },
            { audio: `Error: ${error.message.substring(0, 100)}`, visual: "Error Text", type: "Stock Video" }
        ]
    })
  }
}

// Helper: Backup function if 2.5 isn't live for your key yet
async function fallbackToGemini2(prompt: string, apiKey: string) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: `Create 3 video scenes about: ${prompt}. Return strictly a JSON array with keys: audio, visual, type.` }] }]
      })
    })
    const data = await response.json()
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || ""
    const start = text.indexOf('[')
    const end = text.lastIndexOf(']') + 1
    if (start !== -1) {
        return NextResponse.json({ data: JSON.parse(text.slice(start, end)) })
    }
    return NextResponse.json({ data: [{ audio: "Fallback failed", visual: "Error", type: "Stock Video" }] })
}


=== FILE: app\api\ideation\route.ts ===
import { NextResponse } from 'next/server'
import { GoogleGenerativeAI } from '@google/generative-ai'

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!)

export async function POST(req: Request) {
  try {
    const { topic, style } = await req.json()
    const model = genAI.getGenerativeModel({ 
        model: "gemini-2.5-flash",
        generationConfig: { responseMimeType: "application/json" }
    })

    const prompt = `
      ROLE: YouTube Viral Strategist.
      TASK: Generate 6 high-potential video concepts for the topic: "${topic}".
      STYLE: ${style || 'General'}.
      
      OUTPUT FORMAT (JSON ARRAY):
      [
        {
          "title": "Clickable Title (Under 60 chars)",
          "hook": "First 10 seconds script hook...",
          "thumbnail": "Visual description of the thumbnail",
          "score": 85 (Predict viral score 1-100 based on curiosity gap)
        }
      ]
    `

    const result = await model.generateContent(prompt)
    const response = await result.response
    const ideas = JSON.parse(response.text())

    return NextResponse.json({ ideas })
    
  } catch (error) {
    return NextResponse.json({ error: 'Failed to ideate' }, { status: 500 })
  }
}


=== FILE: app\api\marketing\route.ts ===
import { NextResponse } from 'next/server'
import { MarketingService } from '@/lib/services/marketing.service'

export async function POST(req: Request) {
  try {
    const { projectId } = await req.json();

    if (!projectId) {
      return NextResponse.json({ error: 'Missing projectId' }, { status: 400 });
    }

    const data = await MarketingService.generateMetadata(projectId);

    return NextResponse.json({ 
      success: true, 
      data 
    });

  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}


=== FILE: app\api\proxy\route.ts ===
import { NextResponse } from 'next/server'

export async function GET(req: Request) {
  const { searchParams } = new URL(req.url)
  const url = searchParams.get('url')

  if (!url) return new NextResponse('Missing URL', { status: 400 })

  try {
    const response = await fetch(url)
    if (!response.ok) throw new Error(`Failed to fetch source: ${response.status}`)

    const contentType = response.headers.get('content-type') || 'image/jpeg'
    const arrayBuffer = await response.arrayBuffer()

    // Return the image as if it came from OUR server
    return new NextResponse(arrayBuffer, {
      headers: {
        'Content-Type': contentType,
        'Access-Control-Allow-Origin': '*', // Allow anyone to see it
        'Cache-Control': 'public, max-age=31536000, immutable',
      },
    })
  } catch (error) {
    console.error('Proxy Error:', error)
    return new NextResponse('Failed to proxy image', { status: 500 })
  }
}


=== FILE: app\api\settings\validate\route.ts ===
import { NextResponse } from 'next/server'
import OpenAI from 'openai'
import { GoogleGenerativeAI } from '@google/generative-ai'

export async function POST(req: Request) {
  try {
    const { openai, gemini } = await req.json();
    const availableModels = [];

    // 1. Test OpenAI
    if (openai) {
      try {
        const client = new OpenAI({ apiKey: openai });
        // Tiny request to verify key
        await client.models.list(); 
        
        // If successful, add standard options
        availableModels.push({ id: 'gpt-4-turbo-preview', name: 'OpenAI GPT-4 Turbo', provider: 'openai' });
        availableModels.push({ id: 'gpt-3.5-turbo', name: 'OpenAI GPT-3.5 Turbo', provider: 'openai' });
      } catch (e) {
        console.warn('OpenAI Key Invalid');
      }
    }

    // 2. Test Gemini
    if (gemini) {
      try {
        const genAI = new GoogleGenerativeAI(gemini);
        const model = genAI.getGenerativeModel({ model: "gemini-pro" });
        // Tiny generation to verify
        await model.generateContent("Test");
        
        availableModels.push({ id: 'gemini-pro', name: 'Google Gemini Pro', provider: 'google' });
      } catch (e) {
        console.warn('Gemini Key Invalid');
      }
    }

    // 3. Always add the Free Path
    availableModels.push({ id: 'mock-free', name: 'Free / Mock Mode (No Key Required)', provider: 'internal' });

    return NextResponse.json({ 
      success: true, 
      models: availableModels 
    });

  } catch (error: any) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}


=== FILE: app\dashboard\ideation\page.tsx ===
'use client'
import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { supabase } from '@/lib/supabaseClient'

export default function IdeationPage() {
  const router = useRouter()
  const [topic, setTopic] = useState('')
  const [loading, setLoading] = useState(false)
  const [ideas, setIdeas] = useState<any[]>([])

  const generateIdeas = async () => {
    if (!topic) return
    setLoading(true)
    setIdeas([]) // Clear previous results
    try {
      const res = await fetch('/api/ideation', {
        method: 'POST',
        body: JSON.stringify({ topic, style: 'Viral' })
      })
      const data = await res.json()
      if (data.ideas) setIdeas(data.ideas)
    } catch (e) { alert("AI Brain Freeze ðŸ¥¶") }
    setLoading(false)
  }

  const convertToProject = async (idea: any) => {
    try {
        console.log("1. Authenticating...");
        
        // 1. GET THE USER (Crucial Fix)
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
            alert("Please log in to create a project.");
            return;
        }

        console.log("User found:", user.id);
        console.log("2. Creating project...", idea.title);

        // 2. Create the project with USER_ID attached
        const { data, error } = await supabase.from('projects').insert({
            title: idea.title,
            user_id: user.id, // <--- This solves the "null value" error
            content: JSON.stringify([{ audio: idea.hook, visual: "Intro Hook", type: "Stock Video" }]),
            status: 'draft',
            settings: { pacing: 'fast' }
        }).select().single()

        // 3. Check for DB Errors
        if (error) {
            console.error("Supabase Insert Error:", error);
            throw error;
        }

        // 4. Redirect on success
        if (data) {
            console.log("Project created! ID:", data.id);
            router.push(`/dashboard/project/${data.id}`)
        }
        
    } catch (err: any) {
        alert("Database Error: " + err.message)
        console.error("Full Error:", err)
    }
  }

  return (
    <div className="min-h-screen bg-gray-950 text-white p-8 font-sans">
      
      {/* Navigation Link Back to Dashboard */}
      <button onClick={() => router.push('/dashboard')} className="mb-8 text-gray-400 hover:text-white">â† Back to Dashboard</button>

      <div className="max-w-6xl mx-auto space-y-8">
        
        {/* Header input */}
        <div className="text-center space-y-4">
          <h1 className="text-4xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">
            Viral Idea Generator
          </h1>
          <div className="flex max-w-xl mx-auto gap-2">
            <input 
              value={topic}
              onChange={(e) => setTopic(e.target.value)}
              placeholder="Enter a topic (e.g. Ancient Rome, Bitcoin)..."
              className="flex-1 bg-gray-900 border border-gray-700 p-4 rounded-lg text-lg focus:border-purple-500 outline-none"
              onKeyDown={(e) => e.key === 'Enter' && generateIdeas()}
            />
            <button 
                onClick={generateIdeas}
                disabled={loading}
                className="bg-purple-600 hover:bg-purple-500 px-8 py-4 rounded-lg font-bold text-lg transition-all"
            >
                {loading ? 'Thinking...' : 'Brainstorm ðŸ§ '}
            </button>
          </div>
        </div>

        {/* Results Area */}
        {ideas.length > 0 && (
            <div className="space-y-4">
                <div className="flex justify-between items-center px-2">
                    <h3 className="text-gray-400 uppercase text-sm font-bold tracking-wider">Generated Concepts</h3>
                    <button onClick={generateIdeas} className="text-purple-400 hover:text-white text-sm font-bold flex items-center gap-1">
                        ðŸ”„ Reroll Ideas
                    </button>
                </div>

                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                {ideas.map((idea, i) => (
                    <div key={i} className="bg-gray-900 border border-gray-800 rounded-xl p-6 hover:border-purple-500 transition-all hover:shadow-2xl hover:shadow-purple-900/20 group flex flex-col">
                    <div className="flex justify-between items-start mb-4">
                        <span className={`px-2 py-1 rounded text-xs font-bold ${idea.score > 80 ? 'bg-green-900 text-green-300' : 'bg-yellow-900 text-yellow-300'}`}>
                            Viral Score: {idea.score}
                        </span>
                    </div>
                    <h3 className="text-xl font-bold mb-2 leading-tight">{idea.title}</h3>
                    <p className="text-gray-400 text-sm mb-6 flex-1">{idea.hook}</p>
                    
                    <button 
                        onClick={() => convertToProject(idea)}
                        className="w-full py-3 bg-gray-800 group-hover:bg-purple-600 rounded-lg font-bold transition-colors shadow-lg"
                    >
                        ðŸš€ Create Project
                    </button>
                    </div>
                ))}
                </div>
            </div>
        )}
      </div>
    </div>
  )
}


=== FILE: app\dashboard\project\[id]\audio\page.tsx ===
'use client'
import { useState, useEffect, use, useRef } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Mic, Play, Pause, RefreshCw, Volume2, Wand2, Loader2 } from 'lucide-react'

export default function AudioPage({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params)
  const projectId = resolvedParams.id
  
  const [scenes, setScenes] = useState<any[]>([])
  // Track the currently playing scene ID
  const [playingId, setPlayingId] = useState<string | null>(null)
  // Track which scene is currently regenerating
  const [regeneratingId, setRegeneratingId] = useState<string | null>(null)
  
  // Ref to hold the actual HTML Audio Element so we can pause it
  const audioPlayerRef = useRef<HTMLAudioElement | null>(null)

  useEffect(() => { fetchScenes() }, [])

  // Cleanup audio when leaving page
  useEffect(() => {
    return () => {
      if (audioPlayerRef.current) {
        audioPlayerRef.current.pause()
      }
    }
  }, [])

  const fetchScenes = async () => {
    const { data } = await supabase
      .from('scenes')
      .select('*, scene_assets(*)')
      .eq('project_id', projectId)
      .order('sequence_order', { ascending: true })
    setScenes(data || [])
  }

  // --- FIXED PLAY/PAUSE LOGIC ---
  const togglePlay = (url: string, id: string) => {
    // 1. If clicking the SAME button that is playing -> PAUSE
    if (playingId === id) {
      audioPlayerRef.current?.pause()
      setPlayingId(null)
      return
    }

    // 2. If clicking a DIFFERENT button -> STOP previous, PLAY new
    if (audioPlayerRef.current) {
      audioPlayerRef.current.pause()
    }

    const newAudio = new Audio(url)
    newAudio.onended = () => setPlayingId(null)
    newAudio.play().catch(e => console.error("Playback failed", e))
    
    audioPlayerRef.current = newAudio
    setPlayingId(id)
  }

  // --- FIXED REGENERATE LOGIC ---
  const handleRegenerate = async (sceneId: string) => {
    setRegeneratingId(sceneId)
    
    try {
      // We reuse the batch API for simplicity in Beta
      // Ideally, we'd have a single-scene endpoint, but this works for Mock mode
      await fetch('/api/generate/audio', {
        method: 'POST',
        body: JSON.stringify({ 
           projectId, 
           userId: (await supabase.auth.getUser()).data.user?.id,
           model: 'mock-free' 
        })
      })
      
      // Refresh data to show new timestamp/file
      await fetchScenes()
    } catch (e) {
      console.error('Regen failed', e)
    } finally {
      setRegeneratingId(null)
    }
  }

  return (
    <div className="p-8 min-h-screen space-y-8">
      
      {/* Header */}
      <div className="flex justify-between items-end border-b border-white/5 pb-8">
        <div>
          <h1 className="text-3xl font-black text-white tracking-tight flex items-center gap-3">
            <Mic className="text-emerald-500" />
            Audio Studio
          </h1>
          <p className="text-slate-500 mt-2">Review voiceovers, adjust pacing, and select voice actors.</p>
        </div>
        
        <div className="flex gap-3">
           <select className="bg-white/5 border border-white/10 rounded-xl px-4 text-sm text-slate-300 focus:outline-none">
              <option>Voice: Adam (Deep)</option>
              <option>Voice: Rachel (Energetic)</option>
           </select>
           <button 
             onClick={() => handleRegenerate('all')} 
             className="px-6 py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-500 transition-all flex items-center gap-2"
           >
             <Wand2 size={18} />
             <span>Generate All</span>
           </button>
        </div>
      </div>

      {/* Audio List */}
      <div className="space-y-4 max-w-4xl">
        {scenes.map((scene) => {
          const audioAsset = scene.scene_assets?.find((a: any) => a.asset_type === 'audio')
          const isRegenerating = regeneratingId === scene.id || regeneratingId === 'all'
          
          return (
            <div key={scene.id} className="bg-[#121214] border border-white/5 p-4 rounded-2xl flex items-center gap-6 group hover:border-emerald-500/30 transition-all">
              
              {/* Scene Number */}
              <div className="w-12 h-12 rounded-xl bg-white/5 flex flex-col items-center justify-center shrink-0">
                 <span className="text-[10px] font-bold text-slate-500 uppercase">Scene</span>
                 <span className="text-lg font-black text-white">{scene.sequence_order}</span>
              </div>

              {/* Script Text */}
              <div className="flex-1">
                 <p className="text-slate-300 text-lg font-medium leading-relaxed">"{scene.audio_text}"</p>
                 <div className="flex items-center gap-3 mt-2">
                    <span className="text-[10px] uppercase font-bold text-slate-600 tracking-widest">Duration: ~6s</span>
                    {audioAsset && !isRegenerating && (
                        <span className="text-[10px] uppercase font-bold text-emerald-500 tracking-widest flex items-center gap-1">
                            <Volume2 size={10} /> Ready
                        </span>
                    )}
                 </div>
              </div>

              {/* Player Controls */}
              <div className="shrink-0 flex items-center gap-3">
                 {audioAsset && !isRegenerating ? (
                   <button 
                     onClick={() => togglePlay(audioAsset.asset_url, scene.id)}
                     className="w-12 h-12 rounded-full bg-emerald-500 text-white flex items-center justify-center hover:scale-110 transition-transform shadow-lg shadow-emerald-900/20"
                   >
                     {playingId === scene.id ? <Pause fill="currentColor" /> : <Play fill="currentColor" className="ml-1" />}
                   </button>
                 ) : (
                   <button className="px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-xs font-bold text-slate-400">
                     {isRegenerating ? '...' : 'No Audio'}
                   </button>
                 )}
                 
                 <button 
                   onClick={() => handleRegenerate(scene.id)}
                   disabled={isRegenerating}
                   className={`p-3 text-slate-600 hover:text-white transition-colors ${isRegenerating ? 'animate-spin text-emerald-500' : ''}`} 
                   title="Regenerate"
                 >
                   {isRegenerating ? <Loader2 size={18} /> : <RefreshCw size={18} />}
                 </button>
              </div>

            </div>
          )
        })}
      </div>
    </div>
  )
}


=== FILE: app\dashboard\project\[id]\export\page.tsx ===
'use client'
import { useState, useEffect, use } from 'react'
import Link from 'next/link'
import { supabase } from '@/lib/supabaseClient'
import { ArrowLeft, Download, Film, Settings, Loader2, CheckCircle } from 'lucide-react'
import LaunchPad from '@/components/launch/LaunchPad'

export default function ExportStudio({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params)
  const projectId = resolvedParams.id

  const [project, setProject] = useState<any>(null)
  const [status, setStatus] = useState<'idle' | 'exporting' | 'complete'>('idle')

  useEffect(() => {
    const fetchProject = async () => {
      const { data } = await supabase.from('projects').select('*').eq('id', projectId).single()
      setProject(data)
    }
    fetchProject()
  }, [projectId])

  const triggerExport = () => {
    setStatus('exporting')
    setTimeout(() => setStatus('complete'), 3500)
  }

  return (
    <div className="min-h-screen bg-[#0a0a0c] text-slate-200 p-8">
      <div className="max-w-7xl mx-auto flex items-center justify-between mb-12">
        <div className="flex items-center gap-5">
          <Link href={`/dashboard/project/${projectId}`} className="p-2.5 hover:bg-white/5 rounded-full border border-white/10 transition">
            <ArrowLeft size={20} />
          </Link>
          <div>
            <h1 className="text-3xl font-bold text-white tracking-tight">Export Studio</h1>
            <p className="text-xs font-mono text-purple-400 uppercase tracking-widest mt-1">{project?.title || 'Loading...'}</p>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-12">
        <div className="lg:col-span-8 space-y-12">
          <div className="bg-black rounded-[2.5rem] border border-white/5 aspect-video flex flex-col items-center justify-center relative shadow-2xl overflow-hidden">
             <div className="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-blue-500/10 animate-pulse" />
             <Film size={56} className="text-white/5 mb-4 relative z-10" />
             <span className="text-white/20 font-mono text-[10px] uppercase tracking-[0.3em] relative z-10">Render Engine Active</span>
          </div>
          <LaunchPad projectId={projectId} />
        </div>

        <div className="lg:col-span-4">
          <div className="bg-white/[0.02] border border-white/10 rounded-[2.5rem] p-8 space-y-8 backdrop-blur-3xl sticky top-8">
            <div className="flex items-center gap-3 text-slate-400">
              <Settings size={18} />
              <h2 className="font-bold uppercase text-xs tracking-widest">Master Settings</h2>
            </div>
            <div className="space-y-4">
                <select className="w-full bg-black/60 border border-white/10 rounded-2xl p-4 text-sm outline-none focus:border-purple-500/50 transition">
                    <option>1080p Full HD (Recommended)</option>
                    <option>2160p 4K UHD</option>
                </select>
            </div>
            <button onClick={triggerExport} disabled={status === 'exporting'} className={`w-full py-5 rounded-2xl font-black text-sm uppercase tracking-widest transition-all flex items-center justify-center gap-3 shadow-2xl ${status === 'exporting' ? 'bg-slate-800 text-slate-500' : status === 'complete' ? 'bg-emerald-600 text-white' : 'bg-white text-black hover:bg-slate-200'}`}>
              {status === 'exporting' ? <><Loader2 className="animate-spin" size={20} /> Packaging...</> : status === 'complete' ? <><CheckCircle size={20} /> Ready</> : <><Download size={20} /> Download</>}
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}


=== FILE: app\dashboard\project\[id]\idea\page.tsx ===
'use client'
import { useState, use } from 'react'
import { Sparkles, ArrowRight, Target, TrendingUp, RefreshCw } from 'lucide-react'
import { supabase } from '@/lib/supabaseClient'
import { useRouter } from 'next/navigation'

export default function IdeaLab({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params)
  const projectId = resolvedParams.id
  const router = useRouter()

  const [topic, setTopic] = useState('')
  const [isGenerating, setIsGenerating] = useState(false)
  const [concepts, setConcepts] = useState<any[]>([])

  // Mock AI Brainstorming
  const generateConcepts = async () => {
    if (!topic) return
    setIsGenerating(true)
    
    // Simulate AI thinking time
    await new Promise(r => setTimeout(r, 1500))

    // Mock Response
    setConcepts([
      {
        title: `The Secret Truth About ${topic}`,
        hook: "Stop scrolling. Everything you know about this is wrong.",
        score: 92,
        angle: "Controversial / Mystery"
      },
      {
        title: `Why ${topic} Will Change Everything in 2026`,
        hook: "If you're ignoring this, you're falling behind.",
        score: 88,
        angle: "Future / Trend"
      },
      {
        title: `${topic}: A Complete Breakdown`,
        hook: "I spent 100 hours researching so you don't have to.",
        score: 85,
        angle: "Educational / Deep Dive"
      }
    ])
    setIsGenerating(false)
  }

  const selectConcept = async (concept: any) => {
    // 1. Update the Project in Supabase
    const { error } = await supabase
      .from('projects')
      .update({
        title: concept.title,
        description: `Angle: ${concept.angle}\nHook: ${concept.hook}`
      })
      .eq('id', projectId)

    if (error) alert('Error saving concept')
    else {
      // 2. Move to Script Phase
      router.push(`/dashboard/project/${projectId}`)
    }
  }

  return (
    <div className="p-12 max-w-5xl mx-auto min-h-screen">
      
      {/* Header */}
      <div className="mb-12">
        <h1 className="text-4xl font-black text-white mb-2 flex items-center gap-3">
          <Target className="text-purple-500" size={32} />
          Idea Lab
        </h1>
        <p className="text-slate-400 text-lg">Brainstorm viral angles before you write a single word.</p>
      </div>

      {/* Input Section */}
      <div className="bg-[#121214] border border-white/5 p-8 rounded-3xl mb-12">
        <label className="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">What is your video about?</label>
        <div className="flex gap-4">
          <input 
            type="text" 
            value={topic}
            onChange={(e) => setTopic(e.target.value)}
            placeholder="e.g. Ancient Rome, Quantum Physics, Bitcoin..."
            className="flex-1 bg-black/40 border border-white/10 rounded-xl px-6 text-xl text-white focus:outline-none focus:border-purple-500/50 transition h-16"
            onKeyDown={(e) => e.key === 'Enter' && generateConcepts()}
          />
          <button 
            onClick={generateConcepts}
            disabled={!topic || isGenerating}
            className="px-8 h-16 bg-white text-black font-bold rounded-xl hover:bg-purple-400 transition-all flex items-center gap-2 disabled:opacity-50"
          >
            {isGenerating ? <RefreshCw className="animate-spin" /> : <Sparkles />}
            <span>Generate</span>
          </button>
        </div>
      </div>

      {/* Results Grid */}
      {concepts.length > 0 && (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-in slide-in-from-bottom-5 duration-500">
          {concepts.map((c, i) => (
            <div key={i} className="group relative bg-[#121214] border border-white/5 p-6 rounded-3xl hover:border-purple-500/50 transition-all hover:-translate-y-1">
              
              {/* Score Badge */}
              <div className="absolute top-6 right-6 flex items-center gap-1.5 px-2 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded-full">
                <TrendingUp size={12} className="text-emerald-500" />
                <span className="text-xs font-bold text-emerald-500">{c.score}</span>
              </div>

              <div className="mb-6">
                <span className="text-[10px] font-bold text-purple-400 uppercase tracking-widest">{c.angle}</span>
                <h3 className="text-xl font-bold text-white mt-2 leading-tight">{c.title}</h3>
              </div>

              <div className="bg-black/20 p-4 rounded-xl border border-white/5 mb-6">
                <span className="text-[10px] text-slate-500 uppercase tracking-widest block mb-1">Opening Hook</span>
                <p className="text-slate-300 italic">"{c.hook}"</p>
              </div>

              <button 
                onClick={() => selectConcept(c)}
                className="w-full py-3 bg-white/5 border border-white/10 rounded-xl text-slate-300 font-bold hover:bg-purple-500 hover:text-white hover:border-purple-500 transition-all flex items-center justify-center gap-2"
              >
                <span>Use This Concept</span>
                <ArrowRight size={16} />
              </button>
            </div>
          ))}
        </div>
      )}

    </div>
  )
}


=== FILE: app\dashboard\project\[id]\launch\page.tsx ===
'use client'
import { useState, use } from 'react'
import { Rocket, Youtube, Instagram, Twitter, Download, Copy, Check } from 'lucide-react'

export default function LaunchPage({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params)
  const projectId = resolvedParams.id
  
  const [activeTab, setActiveTab] = useState('youtube')
  const [copied, setCopied] = useState(false)

  // Mock Marketing Data (This would come from your Marketing AI Service)
  const marketing = {
    youtube: {
      title: "The Secret Truth About Pyramids (You Won't Believe This)",
      description: "Stop scrolling. Everything you know about Ancient Egypt is wrong. In this video, we uncover the hidden engineering...",
      tags: "#History #AncientEgypt #Engineering #Mystery #Documentary"
    },
    shorts: {
      title: "Pyramids were POWER PLANTS?? ⚡️ #Shorts",
      description: "Did the ancients have electricity? The answer might shock you. Link in bio.",
      tags: "#Shorts #HistoryFacts #Conspiracy"
    }
  }

  const currentData = activeTab === 'youtube' ? marketing.youtube : marketing.shorts

  const handleCopy = () => {
    navigator.clipboard.writeText(`${currentData.title}\n\n${currentData.description}\n\n${currentData.tags}`)
    setCopied(true)
    setTimeout(() => setCopied(false), 2000)
  }

  const handleExport = async () => {
    const res = await fetch(`/api/export/${projectId}`, { method: 'POST' })
    const json = await res.json()
    const blob = new Blob([JSON.stringify(json.data, null, 2)], { type: 'application/json' })
    const url = window.URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `project_${projectId}_export.json`
    document.body.appendChild(a)
    a.click()
  }

  return (
    <div className="p-8 min-h-screen max-w-6xl mx-auto">
      
      <div className="mb-12 text-center space-y-4">
        <div className="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl mx-auto flex items-center justify-center shadow-2xl shadow-purple-500/20">
          <Rocket size={32} className="text-white" />
        </div>
        <h1 className="text-4xl font-black text-white">Ready for Liftoff?</h1>
        <p className="text-slate-400 text-lg">Your video is ready. Let's package it for the world.</p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* Left: Platform Selector */}
        <div className="lg:col-span-1 space-y-3">
           <p className="text-xs font-bold text-slate-500 uppercase tracking-widest px-2 mb-2">Select Platform</p>
           
           <button 
             onClick={() => setActiveTab('youtube')}
             className={`w-full p-4 rounded-xl flex items-center gap-4 transition-all ${activeTab === 'youtube' ? 'bg-[#FF0000]/10 border border-[#FF0000]/20 text-white' : 'bg-[#121214] border border-white/5 text-slate-400 hover:bg-white/5'}`}
           >
             <Youtube className={activeTab === 'youtube' ? 'text-[#FF0000]' : 'text-slate-500'} />
             <span className="font-bold">YouTube Main</span>
           </button>

           <button 
             onClick={() => setActiveTab('shorts')}
             className={`w-full p-4 rounded-xl flex items-center gap-4 transition-all ${activeTab === 'shorts' ? 'bg-pink-500/10 border border-pink-500/20 text-white' : 'bg-[#121214] border border-white/5 text-slate-400 hover:bg-white/5'}`}
           >
             <Instagram className={activeTab === 'shorts' ? 'text-pink-500' : 'text-slate-500'} />
             <span className="font-bold">Shorts / Reels</span>
           </button>
           
           <div className="pt-8">
             <button 
               onClick={handleExport}
               className="w-full py-4 bg-white text-black font-bold rounded-xl hover:bg-purple-200 transition-all flex items-center justify-center gap-2"
             >
               <Download size={18} />
               <span>Download Project JSON</span>
             </button>
           </div>
        </div>

        {/* Right: Metadata Editor */}
        <div className="lg:col-span-2 bg-[#121214] border border-white/5 rounded-3xl p-8 relative">
           
           <div className="absolute top-6 right-6">
              <button 
                onClick={handleCopy}
                className="flex items-center gap-2 px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-sm font-bold text-slate-300 hover:bg-white/10 transition-all"
              >
                {copied ? <Check size={14} className="text-emerald-500" /> : <Copy size={14} />}
                <span>{copied ? 'Copied!' : 'Copy Details'}</span>
              </button>
           </div>

           <div className="space-y-6">
              <div className="space-y-2">
                 <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Video Title</label>
                 <input 
                   type="text" 
                   defaultValue={currentData?.title}
                   className="w-full bg-black/40 border border-white/10 rounded-xl px-5 py-4 text-white font-bold text-lg focus:outline-none focus:border-purple-500/50"
                 />
              </div>

              <div className="space-y-2">
                 <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Description</label>
                 <textarea 
                   defaultValue={currentData?.description}
                   className="w-full h-40 bg-black/40 border border-white/10 rounded-xl px-5 py-4 text-slate-300 leading-relaxed focus:outline-none focus:border-purple-500/50 resize-none"
                 />
              </div>

              <div className="space-y-2">
                 <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Tags</label>
                 <div className="flex flex-wrap gap-2">
                    {currentData?.tags.split(' ').map((tag, i) => (
                      <span key={i} className="px-3 py-1.5 bg-blue-500/10 border border-blue-500/20 text-blue-400 rounded-lg text-sm font-medium">
                        {tag}
                      </span>
                    ))}
                 </div>
              </div>
           </div>

        </div>

      </div>
    </div>
  )
}


=== FILE: app\dashboard\project\[id]\visuals\page.tsx ===
'use client'
import { useState, useEffect, use } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Image as ImageIcon, Zap, RefreshCw, Upload, Film, Loader2 } from 'lucide-react'

export default function VisualsPage({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params)
  const projectId = resolvedParams.id
  
  const [scenes, setScenes] = useState<any[]>([])
  const [isGenerating, setIsGenerating] = useState(false)
  
  useEffect(() => { fetchScenes() }, [])

  const fetchScenes = async () => {
    const { data } = await supabase
      .from('scenes')
      .select('*, scene_assets(*)')
      .eq('project_id', projectId)
      .order('sequence_order', { ascending: true })
    setScenes(data || [])
  }

  const runBatchGeneration = async () => {
    setIsGenerating(true)
    try {
      // Call your existing Batch API
      await fetch('/api/generate/batch', {
        method: 'POST',
        body: JSON.stringify({ 
           projectId, 
           userId: (await supabase.auth.getUser()).data.user?.id,
           model: 'mock-free'
        })
      })
      
      // Poll for updates (Simulated for UI smoothness)
      await new Promise(r => setTimeout(r, 2000))
      await fetchScenes()
    } catch (e) {
      alert('Generation failed')
    } finally {
      setIsGenerating(false)
    }
  }

  return (
    <div className="p-8 min-h-screen space-y-8">
      
      {/* Header */}
      <div className="flex justify-between items-end border-b border-white/5 pb-8">
        <div>
          <h1 className="text-3xl font-black text-white tracking-tight flex items-center gap-3">
            <ImageIcon className="text-purple-500" />
            Visual Workspace
          </h1>
          <p className="text-slate-500 mt-2">Curate, regenerate, or upload assets for every scene.</p>
        </div>
        
        <button 
          onClick={runBatchGeneration}
          disabled={isGenerating}
          className="px-6 py-3 bg-indigo-500 text-white font-bold rounded-xl hover:bg-indigo-400 transition-all flex items-center gap-2 disabled:opacity-50"
        >
          {isGenerating ? <Loader2 className="animate-spin" /> : <Zap fill="currentColor" />}
          <span>Generate All Missing</span>
        </button>
      </div>

      {/* The Storyboard Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {scenes.map((scene) => {
          const asset = scene.scene_assets?.[0]
          
          return (
            <div key={scene.id} className="bg-[#121214] border border-white/5 rounded-2xl overflow-hidden group">
              
              {/* Scene Header */}
              <div className="px-4 py-3 border-b border-white/5 flex justify-between items-center bg-black/20">
                <span className="text-xs font-bold text-slate-500 uppercase tracking-widest">Scene {scene.sequence_order}</span>
                <span className="text-[10px] bg-white/5 px-2 py-1 rounded text-slate-400">Image</span>
              </div>

              {/* Asset View */}
              <div className="aspect-video relative bg-black/50 group/image">
                {asset ? (
                  <>
                    <img src={asset.asset_url} className="w-full h-full object-cover" />
                    {/* Hover Overlay */}
                    <div className="absolute inset-0 bg-black/60 opacity-0 group-hover/image:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2">
                       <button className="px-4 py-2 bg-white text-black font-bold rounded-lg flex items-center gap-2 hover:scale-105 transition-transform">
                         <RefreshCw size={16} /> Regenerate
                       </button>
                       <div className="flex gap-2">
                         <button className="p-2 bg-white/10 text-white rounded-lg hover:bg-white/20" title="Upload Custom">
                           <Upload size={16} />
                         </button>
                         <button className="p-2 bg-white/10 text-white rounded-lg hover:bg-white/20" title="Pick Stock Video">
                           <Film size={16} />
                         </button>
                       </div>
                    </div>
                  </>
                ) : (
                  <div className="w-full h-full flex flex-col items-center justify-center text-slate-700 gap-2">
                    <ImageIcon size={32} />
                    <span className="text-xs font-bold">No Asset</span>
                  </div>
                )}
              </div>

              {/* Prompt Text */}
              <div className="p-4">
                 <p className="text-xs text-slate-500 font-bold uppercase mb-1">Visual Prompt</p>
                 <p className="text-sm text-slate-300 line-clamp-2" title={scene.visual_description}>
                   {scene.visual_description || 'No description provided...'}
                 </p>
              </div>

            </div>
          )
        })}
      </div>
    </div>
  )
}


=== FILE: app\dashboard\project\[id]\page.tsx ===
'use client'
import { useState, useEffect, use } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { useJobStatus } from '@/hooks/useJobStatus'
import SceneEditor from '@/components/editor/SceneEditor'
import MarketingModal from '@/components/marketing/MarketingModal'
import { Sparkles, Layout, Zap, CheckCircle2, DollarSign, Download, Volume2, Megaphone, Settings } from 'lucide-react'
import Link from 'next/link'
import { Scene } from '@/lib/types'

export default function ProjectWorkspace({ params }: { params: Promise<{ id: string }> }) {
  const resolvedParams = use(params)
  const projectId = resolvedParams.id

  const [project, setProject] = useState<any>(null)
  const [scenes, setScenes] = useState<Scene[]>([])
  const [estimate, setEstimate] = useState<number>(0)
  const [currentJobId, setCurrentJobId] = useState<string | null>(null)
  
  const [isExporting, setIsExporting] = useState(false)
  const [showMarketing, setShowMarketing] = useState(false)
  const [isGeneratingMarketing, setIsGeneratingMarketing] = useState(false)
  const [marketingData, setMarketingData] = useState<any>(null)

  const { progress, message, status } = useJobStatus(currentJobId)

  useEffect(() => { fetchProjectData() }, [projectId])
  useEffect(() => { if (scenes.length > 0) fetchCostEstimate() }, [scenes])
  useEffect(() => { 
    if (status === 'completed') {
      fetchProjectData()
      setTimeout(() => setCurrentJobId(null), 3000)
    }
  }, [status])

  const fetchProjectData = async () => {
    const { data: proj } = await supabase.from('projects').select('*').eq('id', projectId).single()
    const { data: scns } = await supabase.from('scenes').select('*, scene_assets(*, created_at)').eq('project_id', projectId).order('sequence_order', { ascending: true })
    setProject(proj)
    setMarketingData(proj?.marketing_data || null)
    setScenes(scns || [])
  }

  const fetchCostEstimate = async () => {
    try {
        const res = await fetch(`/api/analytics/cost?projectId=${projectId}`)
        if (res.ok) {
            const data = await res.json()
            setEstimate(data.estimate)
        }
    } catch(e) { console.warn('Cost estimate failed', e) }
  }

  // --- HELPER: Get Config (Safe Mode) ---
  const getConfig = () => {
    if (typeof window === 'undefined') return { keys: {}, model: 'mock-free' }
    
    const keys = localStorage.getItem('user_api_keys')
    const model = localStorage.getItem('user_selected_model')
    
    return {
      keys: keys ? JSON.parse(keys) : {},
      model: (model && model !== 'undefined' && model !== '') ? model : 'mock-free'
    }
  }

  const handleExport = async () => {
    setIsExporting(true)
    try {
      const res = await fetch(`/api/export/${projectId}`, { method: 'POST' })
      const json = await res.json()
      const blob = new Blob([JSON.stringify(json.data, null, 2)], { type: 'application/json' })
      const url = window.URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `${project.title.replace(/\s+/g, '_')}_export.json`
      document.body.appendChild(a)
      a.click()
    } catch (e) { alert('Export failed') } finally { setIsExporting(false) }
  }

  const handleGenerateMarketing = async () => {
    setIsGeneratingMarketing(true)
    try {
      const { keys, model } = getConfig()
      const res = await fetch('/api/marketing', {
        method: 'POST',
        body: JSON.stringify({ projectId, keys, model })
      })
      const { data } = await res.json()
      setMarketingData(data)
    } catch (e) { console.error(e) } finally { setIsGeneratingMarketing(false) }
  }

  const generateScript = async () => {
    try {
        const { keys, model } = getConfig()
        console.log('Generating script with model:', model)
        
        const res = await fetch('/api/generate/script', {
        method: 'POST',
        body: JSON.stringify({ 
            projectId: projectId, 
            title: project.title, 
            context: project.description, 
            userId: project.user_id,
            keys,
            model 
        })
        })
        const data = await res.json()
        if (data.jobId) setCurrentJobId(data.jobId)
        else console.error('No Job ID returned', data)
    } catch (e) {
        console.error('Script generation error:', e)
        alert('Failed to start script generation. Check console.')
    }
  }

  // --- UPDATED: SENDS MODEL CONFIG ---
  const runBatchAssets = async () => {
    const { keys, model } = getConfig()
    const res = await fetch('/api/generate/batch', {
      method: 'POST',
      body: JSON.stringify({ projectId: projectId, userId: project.user_id, keys, model })
    })
    const data = await res.json()
    if (data.success && data.jobId) setCurrentJobId(data.jobId)
  }

  const runBatchAudio = async () => {
    const { keys } = getConfig()
    const res = await fetch('/api/generate/audio', {
      method: 'POST',
      body: JSON.stringify({ projectId: projectId, userId: project.user_id, keys })
    })
    const data = await res.json()
    if (data.success && data.jobId) setCurrentJobId(data.jobId)
  }

  return (
    <div className="min-h-screen bg-[#0a0a0c] text-slate-200 p-8 pb-32">
      <MarketingModal 
        isOpen={showMarketing} 
        onClose={() => setShowMarketing(false)}
        data={marketingData}
        onGenerate={handleGenerateMarketing}
        isGenerating={isGeneratingMarketing}
      />

      <div className="max-w-5xl mx-auto space-y-8">
        <div className="flex justify-between items-end border-b border-white/5 pb-8">
          <div className="space-y-2">
            <div className="flex items-center gap-3">
               <h1 className="text-4xl font-black text-white tracking-tight">{project?.title || 'Loading...'}</h1>
               <div className="flex items-center gap-1.5 px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 rounded-full">
                  <DollarSign size={12} className="text-emerald-500" />
                  <span className="text-[10px] font-bold text-emerald-500 uppercase tracking-widest">Est: ${estimate}</span>
               </div>
            </div>
            <p className="text-slate-500 flex items-center gap-2 italic">
              <Layout size={14} /> Workspace / Production
            </p>
          </div>
          <div className="flex gap-4">
             <Link href="/dashboard/settings" className="px-3 py-3 bg-white/5 border border-white/10 text-slate-400 rounded-2xl hover:bg-white/10 transition">
               <Settings size={18} />
             </Link>
             <button onClick={() => setShowMarketing(true)} className="px-4 py-3 bg-pink-500/10 border border-pink-500/20 text-pink-400 rounded-2xl font-bold flex items-center gap-2 hover:bg-pink-500/20 transition-all">
               <Megaphone size={18} /> Marketing
             </button>
             <button onClick={handleExport} disabled={isExporting} className="px-4 py-3 bg-white/5 border border-white/10 text-white rounded-2xl font-bold flex items-center gap-2 hover:bg-white/10 transition-all">
               <Download size={18} /> Export
             </button>
             <button onClick={runBatchAudio} disabled={status === 'processing' || scenes.length === 0} className="px-4 py-3 bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 rounded-2xl font-bold flex items-center gap-2 hover:bg-emerald-500/20 transition-all disabled:opacity-30">
               <Volume2 size={18} /> Audio
             </button>
             <button onClick={runBatchAssets} disabled={status === 'processing' || scenes.length === 0} className="px-6 py-3 bg-indigo-500/10 border border-indigo-500/20 text-indigo-400 rounded-2xl font-bold flex items-center gap-2 hover:bg-indigo-500/20 transition-all disabled:opacity-30">
              <Zap size={18} /> Visuals
            </button>
            <button onClick={generateScript} disabled={status === 'processing'} className="px-8 py-3 bg-white text-black rounded-2xl font-bold flex items-center gap-2 hover:bg-purple-400 transition-all active:scale-95 disabled:opacity-50">
              <Sparkles size={18} /> {scenes.length > 0 ? 'Reroll' : 'Script'}
            </button>
          </div>
        </div>

        {currentJobId && (
          <div className={`rounded-2xl p-6 transition-all duration-500 ${status === 'completed' ? 'bg-emerald-500/10 border border-emerald-500/20' : 'bg-purple-500/10 border border-purple-500/20'}`}>
            <div className="flex justify-between items-center mb-4">
               <div className="flex items-center gap-3">
                 {status === 'completed' ? <CheckCircle2 className="text-emerald-500" size={20} /> : <div className="w-2 h-2 bg-purple-500 rounded-full animate-ping" />}
                 <span className={`text-sm font-bold uppercase tracking-widest ${status === 'completed' ? 'text-emerald-500' : 'text-purple-400'}`}>{message}</span>
               </div>
               <span className={`text-sm font-mono ${status === 'completed' ? 'text-emerald-500' : 'text-purple-400'}`}>{progress}%</span>
            </div>
            <div className="h-1.5 bg-white/5 rounded-full overflow-hidden">
               <div className={`h-full transition-all duration-700 ${status === 'completed' ? 'bg-emerald-500' : 'bg-purple-500'}`} style={{ width: `${progress}%` }} />
            </div>
          </div>
        )}

        <div className="grid gap-8">
          {scenes.map((scene) => (
            <SceneEditor 
              key={scene.id} 
              scene={scene} 
              onUpdate={(id: string, field: string, val: string) => { 
                setScenes(scenes.map(s => s.id === id ? { ...s, [field]: val } : s)) 
              }} 
              onDelete={fetchProjectData} 
            />
          ))}
        </div>
      </div>
    </div>
  )
}


=== FILE: app\dashboard\settings\page.tsx ===
'use client'
import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Save, Key, Cpu, ShieldCheck, Video, Palette, Brain, Layers, Film } from 'lucide-react'

export default function SettingsPage() {
  const [loading, setLoading] = useState(false)
  const [settings, setSettings] = useState({
    openai_key: '',
    elevenlabs_key: '',
    replicate_key: '',
    // Workflow & Providers
    default_script_provider: 'gemini',
    default_image_provider: 'replicate',
    stock_enabled: true,
    export_preference: 'video_full',
    // Channel DNA
    brand_voice_description: '',
    brand_visual_style: ''
  })

  useEffect(() => {
    fetchSettings()
  }, [])

  const fetchSettings = async () => {
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return

    let { data, error } = await supabase
      .from('user_settings')
      .select('*')
      .eq('user_id', user.id)
      .single()

    if (!data && !error) {
       // Create default if missing
       const { data: newData } = await supabase.from('user_settings').insert([{ user_id: user.id }]).select().single()
       data = newData
    }

    if (data) {
      setSettings({
        openai_key: data.openai_key || '',
        elevenlabs_key: data.elevenlabs_key || '',
        replicate_key: data.replicate_key || '',
        default_script_provider: data.default_script_provider || 'gemini',
        default_image_provider: data.default_image_provider || 'replicate',
        stock_enabled: data.stock_enabled ?? true, // Use ?? to handle boolean false
        export_preference: data.export_preference || 'video_full',
        brand_voice_description: data.brand_voice_description || '',
        brand_visual_style: data.brand_visual_style || ''
      })
    }
  }

  const handleSave = async () => {
    setLoading(true)
    const { data: { user } } = await supabase.auth.getUser()
    
    const { error } = await supabase
      .from('user_settings')
      .upsert({ 
        user_id: user?.id,
        ...settings
      })

    setLoading(false)
    if (error) {
        console.error(error)
        alert('Error saving settings')
    } else {
        alert('Settings saved successfully!')
    }
  }

  return (
    <div className="p-8 max-w-5xl mx-auto min-h-screen space-y-12 pb-20">
      
      <div className="flex justify-between items-end border-b border-white/5 pb-8">
        <div>
           <h1 className="text-4xl font-black text-white mb-2">Studio Settings</h1>
           <p className="text-slate-400 text-lg">Configure your AI pipeline, API keys, and brand identity.</p>
        </div>
        <button 
          onClick={handleSave}
          disabled={loading}
          className="px-8 py-4 bg-white text-black font-bold rounded-xl hover:bg-purple-300 transition-all flex items-center gap-2 disabled:opacity-50 shadow-xl shadow-white/5"
        >
          {loading ? <span className="animate-spin">⏳</span> : <Save size={18} />}
          <span>Save Changes</span>
        </button>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* LEFT COLUMN: Technical Config */}
        <div className="space-y-8">
            
            {/* 1. Workflow Preferences */}
            <div className="bg-[#121214] border border-white/5 rounded-3xl p-8">
              <div className="flex items-center gap-3 mb-6">
                <div className="p-2 bg-blue-500/10 rounded-lg text-blue-400"><Layers size={20} /></div>
                <h2 className="text-xl font-bold text-white">Production Workflow</h2>
              </div>
              
              <div className="space-y-5">
                 <div className="space-y-2">
                   <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">How do you edit?</label>
                   <select 
                     value={settings.export_preference}
                     onChange={(e) => setSettings({...settings, export_preference: e.target.value})}
                     className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-purple-500/50 focus:outline-none"
                   >
                     <option value="video_full">Full AI Generation (Images + Audio)</option>
                     <option value="capcut_chunks">CapCut Helper (Short Script Chunks)</option>
                     <option value="xml_premiere">Professional (Premiere/Davinci)</option>
                   </select>
                   <p className="text-xs text-slate-500">
                     {settings.export_preference === 'capcut_chunks' 
                       ? "We will break scripts into <500 char chunks for easy TTS pasting." 
                       : "We will generate a complete package with assets linked."}
                   </p>
                 </div>

                 <div className="flex items-center justify-between p-4 bg-black/20 rounded-xl border border-white/5">
                    <span className="text-sm font-bold text-slate-300 flex items-center gap-2">
                        <Film size={16} /> Prioritize Stock Footage?
                    </span>
                    <button 
                       onClick={() => setSettings({...settings, stock_enabled: !settings.stock_enabled})}
                       className={`w-12 h-6 rounded-full transition-colors relative ${settings.stock_enabled ? 'bg-green-500' : 'bg-slate-700'}`}
                    >
                       <div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${settings.stock_enabled ? 'left-7' : 'left-1'}`} />
                    </button>
                 </div>
              </div>
            </div>

            {/* 2. API Keys (The Engine) */}
            <div className="bg-[#121214] border border-white/5 rounded-3xl p-8">
              <div className="flex items-center gap-3 mb-6">
                <div className="p-2 bg-purple-500/10 rounded-lg text-purple-400"><Key size={20} /></div>
                <h2 className="text-xl font-bold text-white">API Keys</h2>
              </div>
              
              <div className="space-y-4">
                 {['openai', 'elevenlabs', 'replicate'].map((provider) => (
                   <div key={provider} className="space-y-1">
                     <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">{provider}</label>
                     <input 
                       type="password" 
                       value={(settings as any)[`${provider}_key`]}
                       onChange={(e) => setSettings({...settings, [`${provider}_key`]: e.target.value})}
                       className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white text-sm focus:border-purple-500/50 focus:outline-none font-mono"
                       placeholder={`Paste your ${provider} key...`}
                     />
                   </div>
                 ))}
              </div>
              <div className="mt-4 flex items-center gap-2 text-[10px] text-slate-500">
                 <ShieldCheck size={12} /> Keys are encrypted.
              </div>
            </div>

        </div>

        {/* RIGHT COLUMN: Creative Config */}
        <div className="space-y-8">
            
            {/* 3. The "Brain" (Model Selection) */}
            <div className="bg-[#121214] border border-white/5 rounded-3xl p-8">
               <div className="flex items-center gap-3 mb-6">
                 <div className="p-2 bg-emerald-500/10 rounded-lg text-emerald-400"><Brain size={20} /></div>
                 <h2 className="text-xl font-bold text-white">Intelligence Provider</h2>
               </div>

               <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Script Writer</label>
                    <select 
                      value={settings.default_script_provider}
                      onChange={(e) => setSettings({...settings, default_script_provider: e.target.value})}
                      className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-emerald-500/50 focus:outline-none"
                    >
                      <option value="gemini">Google Gemini (Fast/Free)</option>
                      <option value="openai">GPT-4o (Precise)</option>
                      <option value="claude">Claude 3.5 (Human-like)</option>
                    </select>
                  </div>
                  
                  <div className="space-y-2">
                    <label className="text-xs font-bold text-slate-500 uppercase tracking-widest">Visual Artist</label>
                    <select 
                      value={settings.default_image_provider}
                      onChange={(e) => setSettings({...settings, default_image_provider: e.target.value})}
                      className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-emerald-500/50 focus:outline-none"
                    >
                      <option value="replicate">Replicate Flux (Realistic)</option>
                      <option value="dalle3">DALL-E 3 (Stylized)</option>
                    </select>
                  </div>
               </div>
            </div>

            {/* 4. Channel DNA (The Moat) */}
            <div className="bg-gradient-to-br from-[#1a1a20] to-[#121214] border border-purple-500/20 rounded-3xl p-8 relative overflow-hidden">
               <div className="absolute top-0 right-0 w-32 h-32 bg-purple-500/10 blur-3xl rounded-full" />
               
               <div className="flex items-center gap-3 mb-6 relative z-10">
                 <div className="p-2 bg-purple-500 rounded-lg text-white shadow-lg shadow-purple-500/20"><Palette size={20} /></div>
                 <h2 className="text-xl font-bold text-white">Channel DNA</h2>
               </div>

               <div className="space-y-5 relative z-10">
                  <div className="space-y-2">
                     <label className="text-xs font-bold text-purple-300 uppercase tracking-widest">Brand Voice</label>
                     <textarea 
                       value={settings.brand_voice_description}
                       onChange={(e) => setSettings({...settings, brand_voice_description: e.target.value})}
                       className="w-full h-24 bg-black/40 border border-purple-500/20 rounded-xl px-4 py-3 text-white focus:border-purple-500 focus:outline-none text-sm leading-relaxed resize-none placeholder-purple-900/50"
                       placeholder="e.g. Sarcastic, fast-paced, Gen-Z slang, uses metaphors about space..."
                     />
                  </div>

                  <div className="space-y-2">
                     <label className="text-xs font-bold text-purple-300 uppercase tracking-widest">Visual Style</label>
                     <textarea 
                       value={settings.brand_visual_style}
                       onChange={(e) => setSettings({...settings, brand_visual_style: e.target.value})}
                       className="w-full h-24 bg-black/40 border border-purple-500/20 rounded-xl px-4 py-3 text-white focus:border-purple-500 focus:outline-none text-sm leading-relaxed resize-none placeholder-purple-900/50"
                       placeholder="e.g. Dark moody lighting, neon accents, cyberpunk aesthetic, 4k 3d render..."
                     />
                  </div>
               </div>
            </div>

        </div>

      </div>
    </div>
  )
}


=== FILE: app\dashboard\layout.tsx ===
import Sidebar from '@/components/layout/Sidebar'

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="flex min-h-screen bg-[#0a0a0c]">
      {/* 1. Fixed Sidebar */}
      <Sidebar />

      {/* 2. Main Content Area (Pushed right by 16rem/64px) */}
      <main className="flex-1 ml-64 min-h-screen">
        {children}
      </main>
    </div>
  )
}


=== FILE: app\dashboard\page.tsx ===
'use client'
import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabaseClient'
import Link from 'next/link'
import { Plus, Trash2 } from 'lucide-react'

export default function Dashboard() {
  const [projects, setProjects] = useState<any[]>([])

  useEffect(() => {
    fetchProjects()
  }, [])

  const fetchProjects = async () => {
    const { data: { user } } = await supabase.auth.getUser()
    if (!user) return

    const { data, error } = await supabase
      .from('projects')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false })
    
    if (data) setProjects(data)
  }

  const deleteProject = async (id: string) => {
    if (!confirm('Are you sure?')) return
    await supabase.from('projects').delete().eq('id', id)
    fetchProjects()
  }

  return (
    <div className="p-8">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-bold text-white mb-1">Creator Studio</h1>
          <p className="text-slate-400">Manage your viral video projects</p>
        </div>
        <Link href="/dashboard/create">
          <button className="bg-white text-black px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-slate-200 transition">
            <Plus size={18} /> New Project
          </button>
        </Link>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {projects.map((project) => (
          <div key={project.id} className="bg-[#121214] border border-white/10 rounded-xl p-6 hover:border-purple-500/50 transition group relative">
            <div className="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition">
               <button onClick={(e) => { e.preventDefault(); deleteProject(project.id) }} className="p-2 text-slate-600 hover:text-red-500">
                 <Trash2 size={16} />
               </button>
            </div>
            
            <Link href={`/dashboard/project/${project.id}`} className="block">
              <div className="mb-4">
                 <span className={`text-[10px] font-bold px-2 py-1 rounded uppercase tracking-widest ${project.status === 'completed' ? 'bg-green-500/10 text-green-500' : 'bg-blue-500/10 text-blue-500'}`}>
                   {project.status || 'Draft'}
                 </span>
              </div>
              <h3 className="text-xl font-bold text-white mb-2 line-clamp-2">{project.title}</h3>
              <p className="text-sm text-slate-500 line-clamp-2">{project.description || 'No description'}</p>
            </Link>
          </div>
        ))}

        {projects.length === 0 && (
          <div className="col-span-full py-20 text-center border border-dashed border-white/10 rounded-xl">
             <p className="text-slate-500 mb-4">No projects found</p>
             <Link href="/dashboard/create">
               <button className="text-purple-400 hover:underline">Create your first one</button>
             </Link>
          </div>
        )}
      </div>
    </div>
  )
}


=== FILE: app\login\page.tsx ===
'use client'
import { useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'
import { Auth } from '@supabase/auth-ui-react'
import { ThemeSupa } from '@supabase/auth-ui-shared'
import { useRouter } from 'next/navigation'

export default function LoginPage() {
  const router = useRouter()

  useEffect(() => {
    // If user is already logged in, kick them to dashboard
    const checkUser = async () => {
      const { data: { session } } = await supabase.auth.getSession()
      if (session) router.push('/dashboard')
    }
    checkUser()

    // Listen for login success
    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
      if (session) router.push('/dashboard')
    })

    return () => subscription.unsubscribe()
  }, [router])

  return (
    <div className="min-h-screen bg-gray-950 flex items-center justify-center p-4">
      <div className="w-full max-w-md bg-gray-900 p-8 rounded-xl border border-gray-800 shadow-2xl">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">
            Creator Studio
          </h1>
          <p className="text-gray-400 mt-2">Log in or Sign up to continue</p>
        </div>
        
        <Auth
          supabaseClient={supabase}
          appearance={{ 
            theme: ThemeSupa,
            variables: {
              default: {
                colors: {
                  brand: '#9333ea', // Purple
                  brandAccent: '#7e22ce',
                  inputText: 'white',
                  inputBackground: '#1f2937',
                  inputLabelText: '#9ca3af',
                }
              }
            }
          }}
          theme="dark"
          providers={[]} // Add 'google' here later if you want
        />
      </div>
    </div>
  )
}


=== FILE: app\globals.css ===
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --background: #0a0a0c;
  --foreground: #ededed;
}

body {
  color: var(--foreground);
  background: var(--background);
  font-family: Arial, Helvetica, sans-serif;
}


=== FILE: app\layout.tsx ===
import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css"; // <--- THIS WAS LIKELY MISSING

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "AI Creator Studio",
  description: "Generate viral videos with AI",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased bg-[#0a0a0c] text-white`}
      >
        {children}
      </body>
    </html>
  );
}


=== FILE: app\page.tsx ===
import Link from 'next/link'

export default function Home() {
  return (
    <div className="min-h-screen bg-black text-white flex flex-col items-center justify-center p-4">
      
      {/* Hero Section */}
      <div className="max-w-4xl text-center space-y-8">
        
        <h1 className="text-6xl md:text-8xl font-extrabold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">
          Creator Studio
        </h1>
        
        <p className="text-xl md:text-2xl text-gray-400 max-w-2xl mx-auto">
          The all-in-one AI platform for modern creators.
          <br />
          <span className="text-white font-bold">Ideate. Write. Visualize. Launch.</span>
        </p>

        {/* Action Buttons */}
        <div className="flex flex-col md:flex-row gap-4 justify-center items-center mt-10">
          
          {/* Main Sign Up / Login Button */}
          <Link 
            href="/login" 
            className="px-8 py-4 bg-white text-black text-lg font-bold rounded-full hover:scale-105 transition-transform shadow-[0_0_40px_-10px_rgba(255,255,255,0.3)]"
          >
            Get Started For Free
          </Link>

          <Link 
            href="/login" 
            className="px-8 py-4 bg-gray-900 text-gray-300 text-lg font-bold rounded-full border border-gray-800 hover:bg-gray-800 transition-colors"
          >
            Log In
          </Link>
          
        </div>

      </div>

      {/* Footer / Trust Badge */}
      <div className="absolute bottom-10 text-gray-600 text-sm">
        Powered by Gemini & Supabase
      </div>

    </div>
  )
}


=== FILE: components\editor\SceneEditor.tsx ===
'use client'
import { Scene } from '@/lib/types'
import { Trash2, Sparkles, Image as ImageIcon, Volume2, Clock, Wand2, MoreVertical } from 'lucide-react'
import { useState } from 'react'

interface SceneEditorProps {
  scene: Scene
  onUpdate: (id: string, field: string, value: string) => void
  onDelete: () => void
}

export default function SceneEditor({ scene, onUpdate, onDelete }: SceneEditorProps) {
  const [isHovered, setIsHovered] = useState(false)

  // Filter for assets
  const visuals = scene.scene_assets?.filter(a => a.asset_type !== 'audio') || [];
  const audios = scene.scene_assets?.filter(a => a.asset_type === 'audio') || [];
  
  const activeAsset = visuals.length > 0 ? visuals[0] : null;
  const hasAudio = audios.length > 0;

  // Mock duration estimation (approx 150 words per minute)
  const wordCount = scene.audio_text?.split(' ').length || 0;
  const duration = Math.max(2, Math.round((wordCount / 150) * 60)); 

  return (
    <div 
      className="group relative bg-[#121214] border border-white/5 rounded-3xl overflow-hidden transition-all hover:border-purple-500/30 hover:shadow-2xl hover:shadow-purple-900/10"
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      
      {/* 1. Cinematic Header */}
      <div className="h-10 bg-white/5 border-b border-white/5 flex items-center justify-between px-4">
        <div className="flex items-center gap-4">
           {/* Scene Number Badge */}
           <div className="flex items-center gap-2">
             <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Scene</span>
             <div className="w-5 h-5 rounded bg-purple-500 text-white flex items-center justify-center text-[10px] font-bold">
               {scene.sequence_order}
             </div>
           </div>
           
           {/* Duration Estimate */}
           <div className="flex items-center gap-1.5 text-slate-600">
             <Clock size={12} />
             <span className="text-[10px] font-mono font-medium">~{duration}s</span>
           </div>

           {/* Audio Status */}
           {hasAudio && (
             <div className="flex items-center gap-1.5 px-2 py-0.5 bg-emerald-500/10 rounded-full">
                <Volume2 size={10} className="text-emerald-500" />
                <span className="text-[9px] font-bold text-emerald-500 uppercase tracking-widest">VO Ready</span>
             </div>
           )}
        </div>

        {/* Actions */}
        <div className={`flex items-center gap-2 transition-opacity duration-200 ${isHovered ? 'opacity-100' : 'opacity-0'}`}>
           <button 
             onClick={onDelete}
             className="p-1.5 text-slate-500 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors"
             title="Delete Scene"
           >
             <Trash2 size={14} />
           </button>
           <button className="p-1.5 text-slate-500 hover:text-white hover:bg-white/10 rounded-lg transition-colors">
             <MoreVertical size={14} />
           </button>
        </div>
      </div>

      {/* 2. Main Content Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2">
        
        {/* Left Col: Narration (The Script) */}
        <div className="p-6 border-b md:border-b-0 md:border-r border-white/5 space-y-3 relative">
           <div className="flex justify-between items-end">
             <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
               <Volume2 size={12} /> Narration
             </label>
             <button className="text-[10px] text-purple-400 hover:text-purple-300 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
               <Wand2 size={10} /> Rewrite
             </button>
           </div>
           <textarea 
             value={scene.audio_text || ''}
             onChange={(e) => onUpdate(scene.id, 'audio_text', e.target.value)}
             className="w-full h-32 bg-transparent text-lg text-slate-200 placeholder-slate-700 focus:outline-none resize-none leading-relaxed font-medium"
             placeholder="Write what the narrator says here..."
           />
        </div>

        {/* Right Col: Visuals (The Shot) */}
        <div className="p-6 space-y-4 bg-black/20">
           
           {/* Visual Description Input */}
           <div className="space-y-2">
             <div className="flex justify-between items-end">
                <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                  <ImageIcon size={12} /> Visual Direction
                </label>
                <button className="text-[10px] text-purple-400 hover:text-purple-300 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                  <Sparkles size={10} /> Suggest
                </button>
             </div>
             <input 
               type="text"
               value={scene.visual_description || ''}
               onChange={(e) => onUpdate(scene.id, 'visual_description', e.target.value)}
               className="w-full bg-white/5 border border-white/5 rounded-xl px-3 py-2 text-sm text-purple-200 placeholder-purple-900/50 focus:outline-none focus:border-purple-500/50 transition font-medium"
               placeholder="Describe the scene..."
             />
           </div>

           {/* Asset Preview Window */}
           <div className="aspect-video bg-black/40 rounded-xl border border-white/5 overflow-hidden relative group/asset">
              {activeAsset ? (
                <>
                  <img 
                    src={activeAsset.asset_url} 
                    alt="Scene Asset" 
                    className="w-full h-full object-cover transition-transform duration-700 group-hover/asset:scale-105"
                  />
                  <div className="absolute inset-0 bg-black/50 opacity-0 group-hover/asset:opacity-100 transition-opacity flex items-center justify-center gap-2">
                     <button className="px-3 py-1.5 bg-black/80 text-white text-xs font-bold rounded-lg border border-white/10 hover:bg-purple-600 hover:border-purple-500 transition-all">
                       Regenerate
                     </button>
                  </div>
                  <div className="absolute bottom-2 right-2 px-1.5 py-0.5 bg-black/60 backdrop-blur rounded text-[9px] font-mono text-white/70">
                    {activeAsset.provider}
                  </div>
                </>
              ) : (
                <div className="w-full h-full flex flex-col items-center justify-center text-slate-700 gap-2 border-2 border-dashed border-white/5 m-0.5 rounded-lg">
                   <ImageIcon size={24} />
                   <span className="text-[10px] font-bold uppercase tracking-widest">No Visual</span>
                </div>
              )}
           </div>

        </div>
      </div>
    </div>
  )
}


=== FILE: components\launch\LaunchPad.tsx ===
'use client'
import { useState } from 'react'
import { Sparkles, Copy, Check, Youtube } from 'lucide-react'

export default function LaunchPad({ projectId }: { projectId: string }) {
  const [data, setData] = useState<any>(null)
  const [loading, setLoading] = useState(false)
  const [copied, setCopied] = useState<string | null>(null)

  const generateSEO = async () => {
    setLoading(true)
    const res = await fetch('/api/marketing', {
      method: 'POST',
      body: JSON.stringify({ projectId })
    })
    const json = await res.json()
    setData(json)
    setLoading(false)
  }

  const copyToClipboard = (text: string, id: string) => {
    navigator.clipboard.writeText(text)
    setCopied(id)
    setTimeout(() => setCopied(null), 2000)
  }

  return (
    <div className="bg-white/[0.02] border border-white/10 rounded-[2rem] p-8 space-y-8">
      <div className="flex justify-between items-center">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-red-500/20 rounded-lg text-red-500">
            <Youtube size={20} />
          </div>
          <h2 className="text-xl font-bold text-white tracking-tight">Launch Pad</h2>
        </div>
        <button 
          onClick={generateSEO}
          disabled={loading}
          className="flex items-center gap-2 px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition-all disabled:opacity-50"
        >
          {loading ? 'Optimizing...' : <><Sparkles size={16} /> Generate SEO</>}
        </button>
      </div>

      {data ? (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
          <div className="space-y-2">
            <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Top Title Suggestions</label>
            <div className="space-y-2">
              {data.titles.map((t: string, i: number) => (
                <div key={i} className="flex items-center justify-between p-3 bg-black/40 border border-white/5 rounded-xl group">
                  <span className="text-sm text-slate-200">{t}</span>
                  <button onClick={() => copyToClipboard(t, `title-${i}`)} className="text-slate-500 hover:text-white transition">
                    {copied === `title-${i}` ? <Check size={14} className="text-green-500" /> : <Copy size={14} />}
                  </button>
                </div>
              ))}
            </div>
          </div>

          <div className="space-y-2">
            <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Description</label>
            <div className="relative">
              <textarea 
                readOnly 
                value={data.description} 
                className="w-full h-40 bg-black/40 border border-white/5 rounded-2xl p-4 text-xs leading-relaxed text-slate-400 outline-none"
              />
              <button 
                onClick={() => copyToClipboard(data.description, 'desc')}
                className="absolute top-4 right-4 p-2 bg-white/5 hover:bg-white/10 rounded-lg transition"
              >
                {copied === 'desc' ? <Check size={14} className="text-green-500" /> : <Copy size={14} />}
              </button>
            </div>
          </div>
        </div>
      ) : (
        <div className="py-12 text-center border-2 border-dashed border-white/5 rounded-3xl">
          <p className="text-slate-600 text-sm italic">Click generate to create your marketing metadata.</p>
        </div>
      )}
    </div>
  )
}


=== FILE: components\layout\Sidebar.tsx ===
'use client'
import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { LayoutDashboard, FolderOpen, Settings, Lightbulb, FileText, Image as ImageIcon, Volume2, Rocket, ArrowLeft } from 'lucide-react'

export default function Sidebar() {
  const pathname = usePathname()
  
  // Check if we are inside a specific project
  // Route format: /dashboard/project/[id]
  const isProjectMode = pathname?.includes('/project/')
  const projectId = isProjectMode ? pathname.split('/')[3] : null

  const isActive = (path: string) => pathname === path || pathname?.startsWith(path)

  return (
    <div className="w-64 h-screen bg-[#0a0a0c] border-r border-white/5 flex flex-col fixed left-0 top-0 z-50">
      
      {/* 1. App Logo / Header */}
      <div className="p-6 h-20 flex items-center border-b border-white/5">
        <div className="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center mr-3 font-bold text-white">
          AI
        </div>
        <span className="font-bold text-white tracking-tight">Creator Studio</span>
      </div>

      {/* 2. Navigation Items */}
      <div className="flex-1 overflow-y-auto py-6 space-y-2 px-3">
        
        {/* GLOBAL MENU */}
        <div className="mb-8">
           <p className="px-3 text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Workspace</p>
           <Link href="/dashboard" className={`flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all ${pathname === '/dashboard' ? 'bg-purple-500/10 text-purple-400' : 'text-slate-400 hover:text-slate-200 hover:bg-white/5'}`}>
             <LayoutDashboard size={18} />
             <span>Dashboard</span>
           </Link>
           <Link href="/dashboard/projects" className={`flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all ${pathname === '/dashboard/projects' ? 'bg-purple-500/10 text-purple-400' : 'text-slate-400 hover:text-slate-200 hover:bg-white/5'}`}>
             <FolderOpen size={18} />
             <span>All Projects</span>
           </Link>
        </div>

        {/* CONTEXT MENU (Only shows when inside a project) */}
        {isProjectMode && projectId && (
          <div className="animate-in slide-in-from-left-5 duration-300">
             <div className="px-3 mb-2 flex justify-between items-center">
                <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Active Project</p>
                <Link href="/dashboard" className="text-[10px] text-purple-400 hover:underline">Exit</Link>
             </div>
             
             <div className="space-y-0.5">
               <NavItem href={`/dashboard/project/${projectId}/idea`} icon={<Lightbulb size={18} />} label="Idea Lab" active={pathname.includes('/idea')} />
               <NavItem href={`/dashboard/project/${projectId}`} icon={<FileText size={18} />} label="Script" active={pathname === `/dashboard/project/${projectId}`} />
               <NavItem href={`/dashboard/project/${projectId}/visuals`} icon={<ImageIcon size={18} />} label="Visuals" active={pathname.includes('/visuals')} />
               <NavItem href={`/dashboard/project/${projectId}/audio`} icon={<Volume2 size={18} />} label="Audio" active={pathname.includes('/audio')} />
               <NavItem href={`/dashboard/project/${projectId}/launch`} icon={<Rocket size={18} />} label="Launch" active={pathname.includes('/launch')} />
             </div>
          </div>
        )}

      </div>

      {/* 3. Bottom Actions */}
      <div className="p-4 border-t border-white/5">
        <Link href="/dashboard/settings" className="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-white hover:bg-white/5 transition-all">
          <Settings size={18} />
          <span>Settings</span>
        </Link>
      </div>
    </div>
  )
}

function NavItem({ href, icon, label, active }: { href: string; icon: any; label: string; active: boolean }) {
  return (
    <Link href={href} className={`flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all ${active ? 'bg-purple-500/10 text-purple-400 border border-purple-500/20' : 'text-slate-400 hover:text-slate-200 hover:bg-white/5'}`}>
      {icon}
      <span>{label}</span>
      {active && <div className="ml-auto w-1.5 h-1.5 rounded-full bg-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.5)]" />}
    </Link>
  )
}


=== FILE: components\marketing\MarketingModal.tsx ===
'use client'
import { useState } from 'react'
import { X, Copy, Check, Hash, Type, FileText, Sparkles } from 'lucide-react'

interface MarketingModalProps {
  isOpen: boolean
  onClose: () => void
  data: any
  onGenerate: () => void
  isGenerating: boolean
}

export default function MarketingModal({ isOpen, onClose, data, onGenerate, isGenerating }: MarketingModalProps) {
  const [copied, setCopied] = useState<string | null>(null)

  if (!isOpen) return null

  const copyToClipboard = (text: string, key: string) => {
    navigator.clipboard.writeText(text)
    setCopied(key)
    setTimeout(() => setCopied(null), 2000)
  }

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-[#121214] w-full max-w-2xl rounded-3xl border border-white/10 shadow-2xl flex flex-col max-h-[90vh]">
        
        {/* Header */}
        <div className="p-6 border-b border-white/5 flex justify-between items-center">
          <div className="flex items-center gap-3">
             <div className="p-2 bg-pink-500/10 rounded-lg">
               <Sparkles size={20} className="text-pink-500" />
             </div>
             <h2 className="text-xl font-bold text-white">Viral Metadata Generator</h2>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition"><X size={20} /></button>
        </div>

        {/* Content */}
        <div className="p-6 overflow-y-auto space-y-8 custom-scrollbar">
          
          {!data ? (
            <div className="text-center py-12 space-y-4">
               <p className="text-slate-400">Generate optimized titles, descriptions, and tags for your video.</p>
               <button 
                 onClick={onGenerate} 
                 disabled={isGenerating}
                 className="px-8 py-3 bg-white text-black font-bold rounded-xl hover:bg-pink-400 transition-all disabled:opacity-50"
               >
                 {isGenerating ? 'Analyzing Content...' : 'Generate Metadata'}
               </button>
            </div>
          ) : (
            <>
              {/* Titles Section */}
              <div className="space-y-3">
                <div className="flex items-center gap-2 text-pink-400 text-xs font-bold uppercase tracking-widest">
                  <Type size={14} /> Viral Titles
                </div>
                <div className="grid gap-2">
                  {data.titles.map((title: string, i: number) => (
                    <div key={i} className="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5 hover:border-pink-500/50 transition group">
                       <span className="font-medium text-slate-200">{title}</span>
                       <button onClick={() => copyToClipboard(title, `title-${i}`)} className="text-slate-500 hover:text-white transition">
                         {copied === `title-${i}` ? <Check size={16} className="text-emerald-500" /> : <Copy size={16} />}
                       </button>
                    </div>
                  ))}
                </div>
              </div>

              {/* Description Section */}
              <div className="space-y-3">
                <div className="flex items-center gap-2 text-blue-400 text-xs font-bold uppercase tracking-widest">
                  <FileText size={14} /> SEO Description
                </div>
                <div className="relative group">
                   <textarea 
                     readOnly 
                     value={data.description} 
                     className="w-full h-32 bg-black/30 border border-white/10 rounded-xl p-4 text-slate-300 text-sm leading-relaxed resize-none focus:outline-none"
                   />
                   <button 
                     onClick={() => copyToClipboard(data.description, 'desc')}
                     className="absolute top-4 right-4 p-2 bg-black/50 rounded-lg hover:bg-white text-slate-400 hover:text-black transition"
                   >
                     {copied === 'desc' ? <Check size={16} /> : <Copy size={16} />}
                   </button>
                </div>
              </div>

              {/* Tags Section */}
              <div className="space-y-3">
                <div className="flex items-center gap-2 text-purple-400 text-xs font-bold uppercase tracking-widest">
                  <Hash size={14} /> Smart Tags
                </div>
                <div className="flex flex-wrap gap-2 p-4 bg-black/30 rounded-xl border border-white/10">
                   {data.tags.map((tag: string, i: number) => (
                     <span key={i} className="px-2 py-1 bg-purple-500/10 text-purple-300 text-xs rounded border border-purple-500/20">
                       {tag}
                     </span>
                   ))}
                   <button 
                     onClick={() => copyToClipboard(data.tags.join(' '), 'tags')}
                     className="ml-auto text-xs text-slate-500 hover:text-white flex items-center gap-1"
                   >
                     <Copy size={12} /> Copy All
                   </button>
                </div>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  )
}


=== FILE: components\media\MediaModal.tsx ===
'use client'
import { useState } from 'react'
import { MediaService } from '@/lib/services/media.service'
import { Search, X, ImageIcon, Check } from 'lucide-react'

export default function MediaModal({ sceneId, onClose, onSelect }: any) {
  const [query, setQuery] = useState('')
  const [results, setResults] = useState<any[]>([])
  const [isSearching, setIsSearching] = useState(false)

  const handleSearch = async (e: React.FormEvent) => {
    e.preventDefault()
    setIsSearching(true)
    const media = await MediaService.searchPexels(query)
    setResults(media)
    setIsSearching(false)
  }

  const selectAsset = async (asset: any) => {
    const success = await MediaService.attachAssetToScene(sceneId, asset.url, asset.source)
    if (success) {
      onSelect(sceneId, asset.url)
      onClose()
    }
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
      <div className="bg-[#0f0f12] border border-white/10 w-full max-w-4xl max-h-[80vh] rounded-[2.5rem] flex flex-col overflow-hidden shadow-2xl">
        
        {/* Modal Header */}
        <div className="p-6 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-blue-500/20 rounded-lg text-blue-400">
              <ImageIcon size={20} />
            </div>
            <h2 className="text-xl font-bold text-white tracking-tight">Media Library</h2>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-white/5 rounded-full transition">
            <X size={20} className="text-slate-500" />
          </button>
        </div>

        {/* Search Bar */}
        <form onSubmit={handleSearch} className="p-6">
          <div className="relative">
            <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" size={18} />
            <input 
              autoFocus
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              placeholder="Search high-quality stock photos (e.g. 'cyberpunk city', 'peaceful nature')..."
              className="w-full bg-black/40 border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-white focus:border-blue-500/50 outline-none transition shadow-inner"
            />
          </div>
        </form>

        {/* Results Grid */}
        <div className="flex-1 overflow-y-auto p-6 pt-0">
          {isSearching ? (
            <div className="flex flex-col items-center justify-center py-20 gap-4">
              <div className="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin" />
              <p className="text-sm font-mono text-slate-500 uppercase tracking-widest">Scanning Pexels...</p>
            </div>
          ) : (
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
              {results.map((img) => (
                <button 
                  key={img.id}
                  onClick={() => selectAsset(img)}
                  className="group relative aspect-video rounded-xl overflow-hidden border border-white/5 hover:border-blue-500/50 transition-all"
                >
                  <img src={img.url} alt="Stock result" className="object-cover w-full h-full group-hover:scale-110 transition-transform duration-500" />
                  <div className="absolute inset-0 bg-blue-600/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                    <Check className="text-white" size={32} />
                  </div>
                </button>
              ))}
            </div>
          )}
          
          {results.length === 0 && !isSearching && (
            <div className="text-center py-20 border-2 border-dashed border-white/5 rounded-3xl">
              <p className="text-slate-600 text-sm">Enter a search term to find visuals for your scene.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}


=== FILE: components\modals\DeleteModal.tsx ===
'use client'
import { AlertTriangle, Trash2 } from 'lucide-react'

interface DeleteModalProps {
  isOpen: boolean
  onClose: () => void
  onConfirm: () => void
  isDeleting: boolean
  title?: string
}

export default function DeleteModal({ isOpen, onClose, onConfirm, isDeleting, title }: DeleteModalProps) {
  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-[#121214] border border-red-500/20 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
        
        <div className="p-6 text-center space-y-4">
          <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
             <AlertTriangle size={32} className="text-red-500" />
          </div>
          
          <h2 className="text-xl font-bold text-white">Delete this Project?</h2>
          <p className="text-slate-400 text-sm leading-relaxed">
            You are about to delete <strong>"{title || 'this project'}"</strong>. 
            <br/>This action cannot be undone. All scripts, scenes, and generated assets will be lost forever.
          </p>
        </div>

        <div className="bg-red-500/5 p-4 flex gap-3">
           <button 
             onClick={onClose}
             disabled={isDeleting}
             className="flex-1 py-3 bg-transparent border border-white/10 text-white rounded-xl font-bold hover:bg-white/5 transition"
           >
             Cancel
           </button>
           <button 
             onClick={onConfirm}
             disabled={isDeleting}
             className="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 transition flex items-center justify-center gap-2"
           >
             {isDeleting ? 'Deleting...' : <><Trash2 size={18} /> Delete Forever</>}
           </button>
        </div>
      </div>
    </div>
  )
}


=== FILE: components\LaunchPad.tsx ===
'use client'
import { useState } from 'react'

export default function LaunchPad({ project, script, onClose }: any) {
  const [loading, setLoading] = useState(false)
  const [data, setData] = useState<any>(null)

  const generatePackage = async () => {
    setLoading(true)
    try {
      const res = await fetch('/api/marketing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ script, title: project.title })
      })
      const json = await res.json()
      setData(json.data)
    } catch (e) { alert("Generation failed") }
    setLoading(false)
  }

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text)
    alert("Copied to clipboard!")
  }

  // Export as a file for editing software
  const downloadJSON = () => {
    const blob = new Blob([JSON.stringify({ project, script, marketing: data }, null, 2)], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `${project.title.replace(/\s+/g, '_')}_Package.json`
    a.click()
  }

  return (
    <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
      <div className="bg-gray-900 w-full max-w-4xl h-[85vh] rounded-2xl border border-gray-700 flex flex-col shadow-2xl overflow-hidden">
        
        {/* Header */}
        <div className="p-6 border-b border-gray-800 flex justify-between items-center bg-gray-800/50">
          <div>
              <h2 className="text-2xl font-bold text-white">ðŸš€ Launch Control</h2>
              <p className="text-gray-400 text-sm">Prepare your video for liftoff</p>
          </div>
          <button onClick={onClose} className="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>

        {/* Content Area */}
        <div className="flex-1 overflow-y-auto p-8">
            {!data ? (
                <div className="h-full flex flex-col items-center justify-center space-y-6">
                    <div className="text-center space-y-2">
                        <p className="text-xl text-white font-medium">Ready to generate metadata?</p>
                        <p className="text-gray-400 text-sm max-w-md mx-auto">We will analyze your script to create SEO-optimized titles, tags, and descriptions.</p>
                    </div>
                    <button 
                        onClick={generatePackage} 
                        disabled={loading}
                        className="bg-purple-600 hover:bg-purple-500 text-white px-8 py-3 rounded-xl font-bold text-lg shadow-lg shadow-purple-900/20 transition-all flex items-center gap-2"
                    >
                        {loading ? (
                            <><span className="animate-spin">âš¡</span> Analyzing Script...</>
                        ) : (
                            <>âœ¨ Generate Launch Package</>
                        )}
                    </button>
                </div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Left Column */}
                    <div className="space-y-6">
                        <div className="bg-gray-950 border border-gray-800 p-4 rounded-xl">
                            <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Optimized Title</label>
                            <div className="flex gap-2">
                                <input readOnly value={data.optimizedTitle} className="bg-transparent w-full text-white font-bold outline-none"/>
                                <button onClick={() => copyToClipboard(data.optimizedTitle)} className="text-blue-400 text-xs hover:text-white">COPY</button>
                            </div>
                        </div>

                        <div className="bg-gray-950 border border-gray-800 p-4 rounded-xl">
                            <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Description</label>
                            <textarea readOnly value={data.description} className="bg-transparent w-full h-40 text-gray-300 text-sm outline-none resize-none"/>
                            <div className="text-right mt-2">
                                <button onClick={() => copyToClipboard(data.description)} className="text-blue-400 text-xs hover:text-white font-bold">COPY DESCRIPTION</button>
                            </div>
                        </div>
                    </div>

                    {/* Right Column */}
                    <div className="space-y-6">
                        <div className="bg-gray-950 border border-gray-800 p-4 rounded-xl">
                            <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Tags</label>
                            <div className="flex flex-wrap gap-2">
                                {data.tags.map((tag: string, i: number) => (
                                    <span key={i} className="bg-gray-800 px-2 py-1 rounded text-xs text-gray-300">#{tag}</span>
                                ))}
                            </div>
                            <div className="text-right mt-2">
                                <button onClick={() => copyToClipboard(data.tags.join(','))} className="text-blue-400 text-xs hover:text-white font-bold">COPY ALL</button>
                            </div>
                        </div>

                        <div className="bg-gray-950 border border-gray-800 p-4 rounded-xl">
                            <label className="text-xs font-bold text-gray-500 uppercase block mb-2">Pinned Comment</label>
                            <div className="flex gap-2 items-start">
                                <p className="text-sm text-gray-300 flex-1">{data.pinnedComment}</p>
                                <button onClick={() => copyToClipboard(data.pinnedComment)} className="text-blue-400 text-xs hover:text-white shrink-0">COPY</button>
                            </div>
                        </div>
                        
                        <button onClick={downloadJSON} className="w-full bg-green-600 hover:bg-green-500 py-3 rounded-lg font-bold text-white shadow-lg">
                            ðŸ’¾ Export Project File (JSON)
                        </button>
                    </div>
                </div>
            )}
        </div>
      </div>
    </div>
  )
}


=== FILE: components\MediaSelector.tsx ===
'use client'
import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'

interface MediaSelectorProps {
  query: string
  onSelect: (url: string) => void
  onClose: () => void
}

export default function MediaSelector({ query, onSelect, onClose }: MediaSelectorProps) {
  const [results, setResults] = useState<any[]>([])
  const [loading, setLoading] = useState(false)
  const [searchTerm, setSearchTerm] = useState(query)
  const [type, setType] = useState('photos') // 'photos', 'videos', 'ai'

  // AI State
  const [generatedImage, setGeneratedImage] = useState<string | null>(null)
  const [uploading, setUploading] = useState(false)

  // Auto-search only if we are in search mode
  useEffect(() => {
    if (type !== 'ai') handleSearch()
  }, [type])

  const handleSearch = async () => {
    setLoading(true)
    try {
      const res = await fetch('/api/assets/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: searchTerm, type })
      })
      const data = await res.json()
      setResults(data.results || [])
    } catch (e) {
      console.error(e)
    }
    setLoading(false)
  }

  const handleGenerateAI = async () => {
    setLoading(true)
    setGeneratedImage(null)
    try {
        const res = await fetch('/api/generate/image', {
            method: 'POST',
            body: JSON.stringify({ prompt: searchTerm })
        })
        const data = await res.json()
        if (data.url) setGeneratedImage(data.url)
        else alert("Generation failed: " + (data.error || "Unknown error"))
    } catch (e) { alert("AI Error") }
    setLoading(false)
  }

  // Save Gemini/AI image to Supabase so it doesn't expire
  const selectAIImage = async () => {
    if (!generatedImage) return
    setUploading(true)
    try {
        let blob;

        // CHECK: Is this a Base64 string (Gemini) or a URL?
        if (generatedImage.startsWith('data:')) {
            // Convert Base64 to Blob
            const base64Data = generatedImage.split(',')[1]
            const byteCharacters = atob(base64Data)
            const byteNumbers = new Array(byteCharacters.length)
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i)
            }
            const byteArray = new Uint8Array(byteNumbers)
            blob = new Blob([byteArray], { type: 'image/jpeg' })
        } else {
            // Fetch URL (Fallback)
            const res = await fetch(generatedImage)
            blob = await res.blob()
        }
        
        // Upload to Supabase Storage
        const fileName = `ai-gen-${Date.now()}.jpg`
        const { data, error } = await supabase.storage.from('assets').upload(fileName, blob)
        
        if (error) throw error

        // Get Public URL
        const { data: publicData } = supabase.storage.from('assets').getPublicUrl(fileName)
        
        // Select it
        onSelect(publicData.publicUrl)
        
    } catch (err: any) {
        alert("Upload failed: " + err.message)
        console.error(err)
    }
    setUploading(false)
  }

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-8 backdrop-blur-sm">
      <div className="bg-gray-900 w-full max-w-5xl h-[85vh] rounded-xl flex flex-col border border-gray-700 shadow-2xl overflow-hidden">
        
        {/* Header */}
        <div className="p-4 border-b border-gray-700 flex gap-4 bg-gray-800/50 shrink-0">
          <input 
            value={searchTerm} 
            onChange={(e) => setSearchTerm(e.target.value)}
            className="flex-1 bg-black/50 border border-gray-600 p-2.5 rounded text-white focus:outline-none focus:border-purple-500"
            placeholder={type === 'ai' ? "Describe the image you want..." : "Search for assets..."}
            onKeyDown={(e) => e.key === 'Enter' && (type === 'ai' ? handleGenerateAI() : handleSearch())}
          />
          <div className="flex bg-gray-700 rounded p-1 shrink-0">
             <button 
                onClick={() => setType('photos')}
                className={`px-4 py-1.5 rounded text-sm font-bold transition-all ${type === 'photos' ? 'bg-purple-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
             >Photos</button>
             <button 
                onClick={() => setType('videos')}
                className={`px-4 py-1.5 rounded text-sm font-bold transition-all ${type === 'videos' ? 'bg-purple-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
             >Videos</button>
             <button 
                onClick={() => setType('ai')}
                className={`px-4 py-1.5 rounded text-sm font-bold transition-all ${type === 'ai' ? 'bg-pink-600 text-white shadow-lg' : 'text-gray-400 hover:text-white'}`}
             >âœ¨ AI Gen</button>
          </div>
          
          <button 
            onClick={type === 'ai' ? handleGenerateAI : handleSearch} 
            className="bg-blue-600 hover:bg-blue-500 px-6 rounded text-white font-bold shrink-0 transition-colors"
          >
            {type === 'ai' ? 'Generate' : 'Search'}
          </button>
          <button onClick={onClose} className="text-gray-400 hover:text-white px-4 shrink-0 text-xl">âœ•</button>
        </div>

        {/* Content Area */}
        <div className="flex-1 overflow-y-auto p-6 bg-gray-950/50">
          {loading ? (
             <div className="h-full flex flex-col items-center justify-center text-gray-400 space-y-4">
                <div className="w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                <p>{type === 'ai' ? "Dreaming up your image..." : "Searching visual database..."}</p>
             </div>
          ) : type === 'ai' ? (
            // --- AI View ---
            <div className="h-full flex flex-col items-center justify-center">
                {!generatedImage ? (
                    <div className="text-center text-gray-500">
                        <span className="text-4xl block mb-2">ðŸŽ¨</span>
                        <p>Type a prompt and hit Generate</p>
                    </div>
                ) : (
                    <div className="flex flex-col items-center gap-4 animate-in fade-in zoom-in duration-300">
                        <img src={generatedImage} className="rounded-lg shadow-2xl max-h-[50vh] border border-gray-700" />
                        <button 
                            onClick={selectAIImage}
                            disabled={uploading}
                            className="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition-all"
                        >
                            {uploading ? 'Saving to Cloud...' : 'Use This Image'}
                        </button>
                        <p className="text-xs text-gray-500">Image will be saved to your project assets</p>
                    </div>
                )}
            </div>
          ) : (
            // --- Search View ---
            results.length === 0 ? (
                <div className="h-full flex items-center justify-center text-gray-500">No results found.</div>
            ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {results.map((item) => (
                <div 
                    key={item.id} 
                    className="group relative cursor-pointer rounded-lg overflow-hidden aspect-video bg-gray-800 border border-transparent hover:border-purple-500 transition-all hover:shadow-purple-500/20 hover:shadow-lg"
                    onClick={() => onSelect(item.type === 'video' ? item.thumbnail : item.url)}
                >
                    <img src={item.thumbnail} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy" />
                    <div className="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/90 to-transparent p-3 pt-8 opacity-0 group-hover:opacity-100 transition-opacity">
                    <p className="text-xs text-white font-bold truncate">{item.provider}</p>
                    <p className="text-[10px] text-gray-300 truncate">by {item.author}</p>
                    </div>
                    {item.type === 'video' && (
                        <div className="absolute top-2 right-2 bg-black/60 rounded px-1.5 py-0.5 text-[10px] font-bold text-white flex items-center gap-1">
                            <span>ðŸŽ¥</span> Video
                        </div>
                    )}
                </div>
                ))}
                </div>
            )
          )}
        </div>
      </div>
    </div>
  )
}


=== FILE: components\ProjectPlayer.tsx ===
'use client'
import { useState, useEffect, useRef } from 'react'

export default function ProjectPlayer({ scenes, onClose }: any) {
  const [index, setIndex] = useState(0)
  const [isPlaying, setIsPlaying] = useState(false)
  const [progress, setProgress] = useState(0)
  
  const audioRef = useRef<HTMLAudioElement>(null)
  const timerRef = useRef<any>(null)

  const currentScene = scenes[index]
  const hasAudio = !!currentScene.audioUrl

  // Handle Play/Pause & Scene Changes
  useEffect(() => {
    if (!isPlaying) {
        audioRef.current?.pause()
        clearTimeout(timerRef.current)
        return
    }

    if (hasAudio) {
        // Play Audio
        audioRef.current?.play().catch(e => console.log("Audio play failed", e))
    } else {
        // No Audio? Show for 4 seconds then advance
        timerRef.current = setTimeout(() => handleNext(), 4000)
    }
  }, [index, isPlaying, hasAudio])

  const handleNext = () => {
    if (index < scenes.length - 1) {
        setIndex(prev => prev + 1)
        setProgress(0)
    } else {
        setIsPlaying(false) // End of video
    }
  }

  const togglePlay = () => setIsPlaying(!isPlaying)

  return (
    <div className="fixed inset-0 bg-black/95 z-[60] flex flex-col items-center justify-center p-4 backdrop-blur-xl">
      
      {/* 1. Main Viewer (16:9 Aspect Ratio) */}
      <div className="relative w-full max-w-5xl aspect-video bg-black rounded-xl border border-gray-800 shadow-2xl overflow-hidden group">
        
        {/* Visual Layer */}
        {currentScene.assetUrl ? (
            currentScene.type?.includes('Video') ? (
                <video 
                    src={currentScene.assetUrl} 
                    className="w-full h-full object-cover" 
                    autoPlay={isPlaying} 
                    loop 
                    muted 
                    playsInline
                />
            ) : (
                <img 
                    src={currentScene.assetUrl} 
                    className="w-full h-full object-cover animate-in fade-in zoom-in duration-[10s]" 
                    alt="Scene visual" 
                />
            )
        ) : (
            <div className="w-full h-full flex flex-col items-center justify-center text-gray-700 space-y-4">
                <span className="text-6xl">ðŸŽ¬</span>
                <p className="font-mono text-sm uppercase tracking-widest">Missing Visual Asset</p>
            </div>
        )}

        {/* Audio Layer (Hidden) */}
        {hasAudio && (
            <audio 
                ref={audioRef} 
                src={currentScene.audioUrl} 
                onEnded={handleNext}
                onTimeUpdate={(e) => {
                    const el = e.currentTarget
                    setProgress((el.currentTime / el.duration) * 100)
                }}
            />
        )}

        {/* Subtitles Layer */}
        <div className="absolute bottom-12 left-0 right-0 text-center px-10">
            <span className="bg-black/60 text-white px-4 py-2 rounded-lg text-lg font-medium shadow-lg backdrop-blur-sm">
                {currentScene.audio || "..."}
            </span>
        </div>

        {/* Controls Overlay (Visible on Hover) */}
        <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-8">
            <button 
                onClick={() => setIndex(Math.max(0, index - 1))}
                className="text-white hover:text-purple-400 transition-colors text-4xl"
            >
                â®
            </button>
            <button 
                onClick={togglePlay}
                className="bg-white text-black rounded-full w-20 h-20 flex items-center justify-center text-4xl hover:scale-105 transition-transform shadow-xl"
            >
                {isPlaying ? 'â¸' : 'â–¶'}
            </button>
            <button 
                onClick={handleNext}
                className="text-white hover:text-purple-400 transition-colors text-4xl"
            >
                â­
            </button>
        </div>

        {/* Progress Bar (Bottom) */}
        <div className="absolute bottom-0 left-0 right-0 h-1.5 bg-gray-800">
            <div 
                className="h-full bg-purple-600 transition-all duration-200 ease-linear"
                style={{ width: `${progress}%` }}
            />
        </div>
      </div>

      {/* 2. Timeline Strip */}
      <div className="w-full max-w-5xl mt-6 flex gap-2 overflow-x-auto pb-4 px-2">
        {scenes.map((s: any, i: number) => (
            <div 
                key={i} 
                onClick={() => { setIndex(i); setIsPlaying(true); }}
                className={`w-24 h-16 shrink-0 rounded-lg overflow-hidden border-2 cursor-pointer transition-all ${index === i ? 'border-purple-500 scale-105 shadow-purple-500/50 shadow-lg' : 'border-gray-800 opacity-50 hover:opacity-100'}`}
            >
                {s.assetUrl ? (
                    <img src={s.assetUrl} className="w-full h-full object-cover" />
                ) : (
                    <div className="w-full h-full bg-gray-900" />
                )}
            </div>
        ))}
      </div>

      {/* Close Button */}
      <button 
        onClick={onClose} 
        className="absolute top-6 right-6 text-white/50 hover:text-white text-4xl"
      >
        âœ•
      </button>

    </div>
  )
}


=== FILE: components\StatusBadge.tsx ===
import React from 'react';

type Status = 'Not Started' | 'In Progress' | 'Complete' | 'Coming Soon';

interface StatusBadgeProps {
  status: Status;
  label: string;
}

const statusConfig: { [key in Status]: { styles: string; icon: string } } = {
  'Not Started': { styles: 'border-gray-600 bg-gray-800 text-gray-400', icon: 'â€“' },
  'In Progress': { styles: 'border-yellow-500 bg-yellow-900 text-yellow-300', icon: 'â³' },
  'Complete': { styles: 'border-green-500 bg-green-900 text-green-300', icon: 'âœ“' },
  'Coming Soon': { styles: 'border-blue-500 bg-blue-900 text-blue-300', icon: 'âœ¨' },
};

const StatusBadge: React.FC<StatusBadgeProps> = ({ status, label }) => {
  const { styles, icon } = statusConfig[status];
  return (
    <div className="flex items-center justify-between">
      <div className="flex items-center">
        <span className={`mr-2.5 flex items-center justify-center h-5 w-5 rounded-full text-xs font-bold border ${styles}`}>
          {icon}
        </span>
        <span className="text-sm text-gray-300">{label}</span>
      </div>
      <span className={`px-2.5 py-0.5 text-xs font-semibold rounded-full ${styles}`}>
        {status}
      </span>
    </div>
  );
};

export default StatusBadge;



=== FILE: components\VideoPlayer.tsx ===
import React from 'react';

interface VideoPlayerProps {
  src: string;
}

const VideoPlayer: React.FC<VideoPlayerProps> = ({ src }) => {
  return (
    <div className="w-full bg-black rounded-lg overflow-hidden">
      <video
        src={src}
        controls
        className="w-full h-full"
      />
    </div>
  );
};

export default VideoPlayer;


=== FILE: conductor\archive\create_export_page_20260206\index.md ===
# Track create_export_page_20260206 Context

- [Specification](./spec.md)
- [Implementation Plan](./plan.md)
- [Metadata](./metadata.json)


=== FILE: conductor\archive\create_export_page_20260206\metadata.json ===
{
  "track_id": "create_export_page_20260206",
  "type": "feature",
  "status": "new",
  "created_at": "2026-02-06T09:59:00Z",
  "updated_at": "2026-02-06T09:59:00Z",
  "description": "Create Export Page in Dashboard"
}


=== FILE: conductor\archive\create_export_page_20260206\plan.md ===
# Implementation Plan: Create Export Page in Dashboard

This plan outlines the steps to develop a new "Export" page within the Creator Studio Dashboard, integrating video preview and YouTube-optimized export settings, as per the approved specification and adherence to the defined workflow.

## Phase 1: Navigation and Page Scaffolding

- [x] Task: Update Project Details Page Navigation
    - [ ] Write tests for the "Export" button on the project details page (`/dashboard/project/[id]`).
    - [ ] Modify `app/dashboard/project/[id]/page.tsx` to add an "Export" button.
    - [ ] Configure the "Export" button to navigate to `/dashboard/project/[id]/export`.
- [x] Task: Create New Export Page
    - [ ] Create the new page file: `app/dashboard/project/[id]/export/page.tsx`.
    - [ ] Implement a basic page structure with a placeholder title (e.g., "Export Video").
- [x] Task: Conductor - User Manual Verification 'Navigation and Page Scaffolding' (Protocol in workflow.md)

## Phase 2: Video Preview and Basic UI

- [x] Task: Implement Video Player Component
    - [ ] Write tests for a reusable `VideoPlayer` component that accepts a video URL as a prop.
    - [ ] Implement the `VideoPlayer` component using standard HTML5 video elements and basic styling.
- [x] Task: Integrate Video Player into Export Page
    - [ ] Modify `app/dashboard/project/[id]/export/page.tsx` to include the `VideoPlayer` component.
    - [ ] Pass a placeholder video URL to the `VideoPlayer` for initial UI testing.
- [x] Task: Add Export Settings Section UI
    - [ ] Add basic UI elements for format and resolution selection to `app/dashboard/project/[id]/export/page.tsx`.
    - [ ] Use placeholder values for format ("MP4") and resolutions ("1080p", "1440p", "2160p") in the UI.
- [x] Task: Conductor - User Manual Verification 'Video Preview and Basic UI' (Protocol in workflow.md)

## Phase 3: Export Logic and API Integration

- [x] Task: Implement Format and Resolution Selection Logic
    - [ ] Write tests for the state management of selected format and resolution on the export page.
    - [ ] Implement the logic to handle user selection of format and resolution.
- [x] Task: Create Placeholder Export API Route
    - [ ] Create a new API route `app/api/export/[id]/route.ts` to handle export requests.
    - [ ] Implement an API route that generates and downloads a dummy ZIP file containing a text file 'script.txt' and a sample image, to simulate a real export bundle.
- [x] Task: Integrate Export Action with API
    - [ ] Write tests for the "Export Video" button's functionality, ensuring it calls the export API.
    - [ ] Modify `app/dashboard/project/[id]/export/page.tsx` to connect the "Export Video" button to the API route, passing selected settings.
- [x] Task: Conductor - User Manual Verification 'Export Logic and API Integration' (Protocol in workflow.md)

## Phase 4: Refinement, Testing, and Verification

- [x] Task: Comprehensive Testing
    - [ ] Run all existing unit tests and ensure they pass.
    - [ ] Conduct integration tests for the entire export workflow (navigation, preview, settings, API call).
    - [ ] Perform UI tests to ensure visual consistency and responsiveness.
- [x] Task: Manual Acceptance Criteria Verification
    - [ ] Manually verify all acceptance criteria listed in `spec.md`.
- [x] Task: Code Review and Cleanup
    - [ ] Review the implemented code for adherence to code style guides and overall quality.
    - [ ] Remove any temporary code or placeholder data.
- [x] Task: Conductor - User Manual Verification 'Refinement, Testing, and Verification' (Protocol in workflow.md)


=== FILE: conductor\archive\create_export_page_20260206\spec.md ===
# Specification: Create Export Page in Dashboard

## 1. Overview
This track involves developing a new "Export" page within the Creator Studio Dashboard. This page will provide users with a dedicated space to review their final video assets and configure optimal settings for export, primarily targeting YouTube uploads. It will include a video preview and configurable export options, enhancing the "Complexity Abstraction" UX by simplifying video preparation.

## 2. Functional Requirements

### FR1: Access to Export Page
An "Export" button will be added to the project details page (`/dashboard/project/[id]`) which, when clicked, navigates the user to the new export page: `/dashboard/project/[id]/export`.

### FR2: Video Preview Display
The "Export" page will feature a prominent video player to preview the final generated video asset.

### FR3: Export Settings Configuration
The "Export" page will include a section for users to configure export settings. This will primarily include:
*   **Format Selection:** Users can choose "MP4" as the export format (H.264 codec).
*   **Resolution Selection:** Users can select from 1080p (1920x1080), 1440p (2560x1440), and 2160p (3840x2160) resolutions.

### FR4: Export Action
A clear "Export Video" button will initiate the video export process based on the selected settings.

## 3. Non-Functional Requirements

### NFR1: Performance
The video preview should load efficiently, and the export process should initiate promptly without significant delays.

### NFR2: Responsiveness
The "Export" page and its components (video player, settings) must be fully responsive and function correctly across various screen sizes and devices.

### NFR3: Maintainability
The code for the export page, including its UI and logic for handling export settings, should be modular and easy to extend for future formats or resolutions.

### NFR4: Error Handling
Appropriate error messages should be displayed to the user if the video asset cannot be loaded or if the export process encounters an issue.

## 4. Acceptance Criteria

### AC1: Page Accessibility
Clicking the "Export" button on a project's detail page successfully navigates to the dedicated export page for that project.

### AC2: Video Preview
The export page displays the generated video asset in a functional video player.

### AC3: Format Selection
The export settings section offers "MP4" as a selectable video format.

### AC4: Resolution Selection
The export settings section offers "1080p", "1440p", and "2160p" as selectable video resolutions.

### AC5: Export Initiation
Clicking the "Export Video" button initiates a process to export the video with the selected format and resolution.

### AC6: UI Consistency
The design and layout of the "Export" page adhere to the application's "Modern & Clean" visual identity.

## 5. Out of Scope
*   Advanced video editing capabilities on the export page.
*   Real-time encoding progress display during export (initial version can show a simple loading state).
*   Support for additional video formats or resolutions beyond MP4, 1080p, 1440p, and 2160p in this initial track.
*   Integration with external video hosting/upload services (e.g., direct YouTube upload).


=== FILE: conductor\archive\refine_project_dashboard_20260206\index.md ===
# Track refine_project_dashboard_20260206 Context

- [Specification](./spec.md)
- [Implementation Plan](./plan.md)
- [Metadata](./metadata.json)


=== FILE: conductor\archive\refine_project_dashboard_20260206\metadata.json ===
{
  "track_id": "refine_project_dashboard_20260206",
  "type": "feature",
  "status": "new",
  "created_at": "2026-02-06T09:39:00Z",
  "updated_at": "2026-02-06T09:39:00Z",
  "description": "Refine the Project Dashboard to show status indicators for the 4 pillars"
}


=== FILE: conductor\archive\refine_project_dashboard_20260206\plan.md ===
# Implementation Plan: Refine Project Dashboard Status Indicators

This plan outlines the steps to enhance the Project Dashboard with status indicators for the four core pillars.

## Phase 1: Setup and Core UI Integration
- [x] Task: Environment Setup
    - [ ] Identify relevant dashboard component files.
    - [ ] Install any new UI library dependencies if required.
- [x] Task: Integrate Basic Status Indicator Component
    - [ ] Write tests for a generic status indicator component (e.g., displaying different states).
    - [ ] Implement a reusable status indicator component (e.g., using Tailwind CSS for styling).
    - [ ] Integrate the status indicator component into a single project card on the dashboard.
- [x] Task: Conductor - User Manual Verification 'Setup and Core UI Integration' (Protocol in workflow.md)

## Phase 2: Pillar Status Logic and Data Integration
- [x] Task: Define Pillar Status Logic
    - [ ] Write tests for functions that determine the status of each pillar based on project data.
    - [ ] Implement functions to determine the status of each pillar (Ideate, Write, Visualize, Launch) based on existing project data structures.
- [x] Task: Integrate Pillar Status into Dashboard
    - [ ] Write tests to verify correct pillar status display on the dashboard.
    - [ ] Pass calculated pillar statuses to the status indicator components on the dashboard.
- [x] Task: Conductor - User Manual Verification 'Pillar Status Logic and Data Integration' (Protocol in workflow.md)

## Phase 3: Refinement and Acceptance Criteria
- [x] Task: Visual Refinement
    - [ ] Write UI tests to ensure consistent styling of status indicators.
    - [ ] Adjust styling of status indicators for optimal visual clarity and alignment with brand guidelines.
- [x] Task: Acceptance Criteria Verification
    - [ ] Manually verify all acceptance criteria outlined in `spec.md`.
- [x] Task: Conductor - User Manual Verification 'Refinement and Acceptance Criteria' (Protocol in workflow.md)


=== FILE: conductor\archive\refine_project_dashboard_20260206\spec.md ===
# Specification: Refine Project Dashboard Status Indicators

## 1. Overview
This track focuses on enhancing the Project Dashboard by integrating clear status indicators for each of the four core pillars: Ideate, Write, Visualize, and Launch. The goal is to provide creators with an at-a-glance understanding of their project's progress across these key stages, aligning with the "Complexity Abstraction" UX philosophy.

## 2. Functional Requirements
*   **FR1: Pillar Status Display:** For each project listed on the dashboard, display a visual status indicator for each of the four pillars.
*   **FR2: Status Definition:** Each pillar's status should reflect its current state based on actions taken within that pillar (e.g., "Ideate" complete if concepts are generated, "Write" complete if a script is finalized).
*   **FR3: Intuitive Visuals:** Status indicators should be intuitive and easily distinguishable (e.g., color-coded icons, progress bars, or clear textual labels).
*   **FR4: Drill-down Capability (Optional for future consideration):** Clicking on a pillar's status indicator could, in a future iteration, navigate to the relevant section of the project for more details.

## 3. Non-Functional Requirements
*   **NFR1: Performance:** The dashboard should load quickly, and status updates should be reflected efficiently without noticeable delays.
*   **NFR2: Responsiveness:** Status indicators should display correctly across various screen sizes and devices.
*   **NFR3: Maintainability:** The implementation should be modular and easily extensible for future status definitions or additional pillars.

## 4. Acceptance Criteria
*   **AC1:** On the Project Dashboard, each project card displays a distinct status indicator for Ideate, Write, Visualize, and Launch.
*   **AC2:** The status indicator for the "Ideate" pillar accurately reflects if ideation concepts have been generated for a given project.
*   **AC3:** The status indicator for the "Write" pillar accurately reflects if a script has been finalized for a given project.
*   **AC4:** The status indicator for the "Visualize" pillar accurately reflects if visual assets have been organized/generated for a given project.
*   **AC5:** The status indicator for the "Launch" pillar accurately reflects if launch-ready assets/metadata have been generated for a given project.
*   **AC6:** The visual style of the status indicators is consistent with the "Modern & Clean" visual identity of the application.

## 5. Out of Scope
*   Detailed analytics or historical tracking of pillar status.
*   Real-time updates of pillar status without page refresh (initially, can be a future enhancement).
*   Complex permissions or user roles related to status modification (assume single user for now).


=== FILE: conductor\code_styleguides\javascript.md ===
# Google JavaScript Style Guide Summary

This document summarizes key rules and best practices from the Google JavaScript Style Guide.

## 1. Source File Basics
- **File Naming:** All lowercase, with underscores (`_`) or dashes (`-`). Extension must be `.js`.
- **File Encoding:** UTF-8.
- **Whitespace:** Use only ASCII horizontal spaces (0x20). Tabs are forbidden for indentation.

## 2. Source File Structure
- New files should be ES modules (`import`/`export`).
- **Exports:** Use named exports (`export {MyClass};`). **Do not use default exports.**
- **Imports:** Do not use line-wrapped imports. The `.js` extension in import paths is mandatory.

## 3. Formatting
- **Braces:** Required for all control structures (`if`, `for`, `while`, etc.), even single-line blocks. Use K&R style ("Egyptian brackets").
- **Indentation:** +2 spaces for each new block.
- **Semicolons:** Every statement must be terminated with a semicolon.
- **Column Limit:** 80 characters.
- **Line-wrapping:** Indent continuation lines at least +4 spaces.
- **Whitespace:** Use single blank lines between methods. No trailing whitespace.

## 4. Language Features
- **Variable Declarations:** Use `const` by default, `let` if reassignment is needed. **`var` is forbidden.**
- **Array Literals:** Use trailing commas. Do not use the `Array` constructor.
- **Object Literals:** Use trailing commas and shorthand properties. Do not use the `Object` constructor.
- **Classes:** Do not use JavaScript getter/setter properties (`get name()`). Provide ordinary methods instead.
- **Functions:** Prefer arrow functions for nested functions to preserve `this` context.
- **String Literals:** Use single quotes (`'`). Use template literals (`` ` ``) for multi-line strings or complex interpolation.
- **Control Structures:** Prefer `for-of` loops. `for-in` loops should only be used on dict-style objects.
- **`this`:** Only use `this` in class constructors, methods, or in arrow functions defined within them.
- **Equality Checks:** Always use identity operators (`===` / `!==`).

## 5. Disallowed Features
- `with` keyword.
- `eval()` or `Function(...string)`.
- Automatic Semicolon Insertion.
- Modifying builtin objects (`Array.prototype.foo = ...`).

## 6. Naming
- **Classes:** `UpperCamelCase`.
- **Methods & Functions:** `lowerCamelCase`.
- **Constants:** `CONSTANT_CASE` (all uppercase with underscores).
- **Non-constant Fields & Variables:** `lowerCamelCase`.

## 7. JSDoc
- JSDoc is used on all classes, fields, and methods.
- Use `@param`, `@return`, `@override`, `@deprecated`.
- Type annotations are enclosed in braces (e.g., `/** @param {string} userName */`).

*Source: [Google JavaScript Style Guide](https://google.github.io/styleguide/jsguide.html)*


=== FILE: conductor\code_styleguides\typescript.md ===
# Google TypeScript Style Guide Summary

This document summarizes key rules and best practices from the Google TypeScript Style Guide, which is enforced by the `gts` tool.

## 1. Language Features
- **Variable Declarations:** Always use `const` or `let`. **`var` is forbidden.** Use `const` by default.
- **Modules:** Use ES6 modules (`import`/`export`). **Do not use `namespace`.**
- **Exports:** Use named exports (`export {MyClass};`). **Do not use default exports.**
- **Classes:**
  - **Do not use `#private` fields.** Use TypeScript's `private` visibility modifier.
  - Mark properties never reassigned outside the constructor with `readonly`.
  - **Never use the `public` modifier** (it's the default). Restrict visibility with `private` or `protected` where possible.
- **Functions:** Prefer function declarations for named functions. Use arrow functions for anonymous functions/callbacks.
- **String Literals:** Use single quotes (`'`). Use template literals (`` ` ``) for interpolation and multi-line strings.
- **Equality Checks:** Always use triple equals (`===`) and not equals (`!==`).
- **Type Assertions:** **Avoid type assertions (`x as SomeType`) and non-nullability assertions (`y!`)**. If you must use them, provide a clear justification.

## 2. Disallowed Features
- **`any` Type:** **Avoid `any`**. Prefer `unknown` or a more specific type.
- **Wrapper Objects:** Do not instantiate `String`, `Boolean`, or `Number` wrapper classes.
- **Automatic Semicolon Insertion (ASI):** Do not rely on it. **Explicitly end all statements with a semicolon.**
- **`const enum`:** Do not use `const enum`. Use plain `enum` instead.
- **`eval()` and `Function(...string)`:** Forbidden.

## 3. Naming
- **`UpperCamelCase`:** For classes, interfaces, types, enums, and decorators.
- **`lowerCamelCase`:** For variables, parameters, functions, methods, and properties.
- **`CONSTANT_CASE`:** For global constant values, including enum values.
- **`_` Prefix/Suffix:** **Do not use `_` as a prefix or suffix** for identifiers, including for private properties.

## 4. Type System
- **Type Inference:** Rely on type inference for simple, obvious types. Be explicit for complex types.
- **`undefined` and `null`:** Both are supported. Be consistent within your project.
- **Optional vs. `|undefined`:** Prefer optional parameters and fields (`?`) over adding `|undefined` to the type.
- **`Array<T>` Type:** Use `T[]` for simple types. Use `Array<T>` for more complex union types (e.g., `Array<string | number>`).
- **`{}` Type:** **Do not use `{}`**. Prefer `unknown`, `Record<string, unknown>`, or `object`.

## 5. Comments and Documentation
- **JSDoc:** Use `/** JSDoc */` for documentation, `//` for implementation comments.
- **Redundancy:** **Do not declare types in `@param` or `@return` blocks** (e.g., `/** @param {string} user */`). This is redundant in TypeScript.
- **Add Information:** Comments must add information, not just restate the code.

*Source: [Google TypeScript Style Guide](https://google.github.io/styleguide/tsguide.html)*


=== FILE: conductor\index.md ===
# Project Context

## Definition
- [Product Definition](./product.md)
- [Product Guidelines](./product-guidelines.md)
- [Tech Stack](./tech-stack.md)

## Workflow
- [Workflow](./workflow.md)
- [Code Style Guides](./code_styleguides/)

## Management
- [Tracks Registry](./tracks.md)
- [Tracks Directory](./tracks/)


=== FILE: conductor\product-guidelines.md ===
# Product Guidelines: Creator Studio Web

## 1. Prose Style for User-Facing Content

**Friendly & Conversational:** All user-facing content, including labels, instructions, and feedback messages, will employ an approachable and supportive tone. We will avoid technical jargon where possible, or explain it clearly when necessary, to ensure the application is welcoming and intuitive for creators of all experience levels. This style aims to build user confidence and foster a positive creative environment.

## 2. Brand Messaging Tone

**Empowering & Efficient:** Our brand messaging will consistently highlight how Creator Studio Web empowers users to achieve their creative visions with remarkable efficiency. The tone will be encouraging and professional, emphasizing the intelligent automation and streamlined workflows that enable creators to bring their ideas to life faster and more effectively. We aim to inspire confidence in their ability to produce high-quality content.

## 3. Visual Identity

**Modern & Clean:** The visual identity of Creator Studio Web will be characterized by a modern, clean, and intuitive aesthetic. We will prioritize clear typography, well-balanced layouts, and a cohesive, professional color palette to ensure a sophisticated and user-friendly experience. UI elements will be designed for easy scannability and direct communication of their function, minimizing visual clutter and enhancing focus on the creative process.


=== FILE: conductor\product.md ===
# Product Vision: Creator Studio Web

## 1. Overarching Goal
**"Ideate. Write. Visualize. Launch."**
To build a comprehensive, end-to-end AI platform that abstracts away the technical complexity of video production. The platform empowers modern creators to move from a raw idea to a ready-to-launch video asset in a single, unified workflow.

## 2. Target Audience
* **Content Creators:** YouTubers, TikTokers, and social media influencers looking to scale production.
* **Marketers:** Professionals needing rapid video concepts and assets without hiring a full production team.
* **Storytellers:** Individuals who have ideas but lack the technical skills to script or visualize them.

## 3. The Four Pillars (Core Features)
The application is structured around four distinct stages of the creator lifecycle:

### Phase 1: Ideate (Viral Engine)
* **Goal:** overcome "writer's block" and identify high-performing concepts.
* **Features:** Trend analysis, concept generation, and viral hook brainstorming.

### Phase 2: Write (AI Scripting)
* **Goal:** Turn loose concepts into structured, production-ready scripts.
* **Features:**
    * AI Script Writer (Powered by Gemini 2.5 Flash).
    * Scene-by-scene breakdown (Audio vs. Visual).
    * Tone and style customization.
    * **Current Status:** Functional (Basic script generation implemented).

### Phase 3: Visualize (Asset Manager)
* **Goal:** Provide the visual and auditory components to match the script.
* **Features:**
    * AI Image Generation (Flux/Pollinations/Imagen).
    * Stock Asset Integration (Pexels/Lorem Picsum).
    * Asset organization per scene.
    * **Current Status:** In-progress (Stock photo mode active; AI generation via link sharing).

### Phase 4: Launch (Distribution)
* **Goal:** Ensure the content reaches the widest possible audience.
* **Features:** SEO metadata generation, thumbnail creation, and platform-specific export optimization.

## 4. User Experience (UX) Philosophy
* **"Complexity Abstraction":** Users should not need to prompt engineer raw LLMs. The UI should offer intuitive buttons ("Generate Script", "Suggest Visuals") that handle the complex prompting in the background.
* **Project-Centric:** All work is organized into "Projects," which act as containers for the script, assets, and settings.

## 5. Technical Context (High Level)
* **Frontend:** Next.js (App Router), React, Tailwind CSS.
* **Backend:** Next.js API Routes (Serverless functions).
* **Database:** Supabase (PostgreSQL).
* **AI Engine:** Google Gemini (Primary), Pollinations.ai (Visuals Fallback).
* **Infrastructure:** Vercel (Hosting).


=== FILE: conductor\setup_state.json ===
{"last_successful_step": "3.3_initial_track_generated"}


=== FILE: conductor\tech-stack.md ===
# Tech Stack: Creator Studio Web

## 1. Core Technologies
*   **Frontend Framework:** Next.js (with React App Router)
*   **Styling:** Tailwind CSS
*   **Programming Languages:** TypeScript, JavaScript

## 2. AI Integration
*   **Primary AI Engine:** Google Gemini (for script generation and other creative AI tasks)
*   **Visual AI Fallback:** Pollinations.ai (for image generation, as a fallback or alternative to primary AI)
*   **Other AI Libraries:** OpenAI (for potential future integrations or specific AI models)

## 3. Backend & Data
*   **Backend Framework:** Next.js API Routes (Serverless functions for handling API calls and backend logic)
*   **Database:** Supabase (PostgreSQL compatible, used for authentication, data storage, and real-time features)

## 4. Infrastructure & Deployment
*   **Hosting Platform:** Vercel (for seamless deployment and scaling of the Next.js application)

## 5. Key Libraries & Tools
*   `@google/generative-ai`: Google Gemini API client library
*   `@supabase/supabase-js`: Supabase client library for interacting with Supabase services
*   `openai`: OpenAI API client library
*   `eslint`: For code linting
*   `typescript`: For type-checking and improved code quality


=== FILE: conductor\tracks.md ===
# Project Tracks

This file tracks all major tracks for the project. Each track has its own detailed plan in its respective folder.


=== FILE: conductor\workflow.md ===
# Workflow Protocols

## 1. Task Workflow
When implementing a task from the plan, follow these steps strictly:

1.  **Context Analysis**:
    * Read the relevant files to understand the current state.
    * Review `spec.md` to ensure alignment with the goal.

2.  **Atomic Implementation**:
    * Make changes to **one file at a time**.
    * After editing a file, check for basic syntax errors.

3.  **Verification**:
    * Verify that the changes match the requirements in the `spec.md`.
    * Ensure no existing functionality is broken.

4.  **Completion**:
    * Mark the task as done in the `plan.md` file (change `[ ]` to `[x]`).
    * Move to the next task in the plan.

## 2. Coding Standards
* **Framework**: Use Next.js 14+ (App Router) patterns.
* **Styling**: Use Tailwind CSS for all styling.
* **Safety**: Do not delete user data or existing functionality without explicit instruction.


=== FILE: hooks\useJobStatus.ts ===
'use client'
import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabaseClient'

export function useJobStatus(jobId: string | null) {
  const [status, setStatus] = useState<string>('idle')
  const [progress, setProgress] = useState<number>(0)
  const [message, setMessage] = useState<string>('')

  useEffect(() => {
    if (!jobId) return

    let intervalId: NodeJS.Timeout

    const fetchJob = async () => {
      const { data } = await supabase
        .from('jobs')
        .select('*')
        .eq('id', jobId)
        .single()
      
      if (data) {
        setStatus(data.status)
        setProgress(data.progress)
        setMessage(data.message)
      }
    }

    // 1. Fetch immediately
    fetchJob()

    // 2. Poll every 1 second (Backup for missed events)
    intervalId = setInterval(fetchJob, 1000)

    // 3. Realtime Subscription (Primary method)
    const channel = supabase
      .channel(`job-${jobId}`)
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'jobs', filter: `id=eq.${jobId}` }, (payload: any) => {
           setStatus(payload.new.status)
           setProgress(payload.new.progress)
           setMessage(payload.new.message)
      })
      .subscribe()

    return () => { 
      supabase.removeChannel(channel)
      clearInterval(intervalId) 
    }
  }, [jobId])

  return { status, progress, message }
}


=== FILE: lib\ai\scriptGenerator.ts ===
import { GoogleGenerativeAI } from '@google/generative-ai'

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!)

export async function generateScript(title: string, pacing: string = 'Cinematic') {
  const model = genAI.getGenerativeModel({ 
    model: "gemini-2.5-flash",
    generationConfig: { responseMimeType: "application/json" }
  })

  // This relies on the logic from your original 'ScriptService'
  const prompt = `
    ROLE: You are an elite video director.
    TASK: Write a structured script for a video titled: "${title}".
    PACING: ${pacing} (Fast cuts if 'Fast', slow pans if 'Cinematic').
    
    REQUIREMENTS:
    1.  Output a raw JSON Array of scene objects.
    2.  "visual": detailed description of the stock footage/image needed.
    3.  "audio": the voiceover text for this exact shot.
    4.  "type": "Stock Video" or "Stock Photo".
    5.  "duration": estimated seconds (e.g., 3, 5, 8).
    
    STRICT FORMAT:
    [
      { "audio": "...", "visual": "...", "type": "Stock Video", "duration": 5 },
      ...
    ]
  `

  const result = await model.generateContent(prompt)
  const response = await result.response
  return JSON.parse(response.text())
}


=== FILE: lib\services\ai.service.ts ===
import { GoogleGenerativeAI } from "@google/generative-ai"
import { supabaseAdmin } from '@/lib/supabaseServer'
import { withRetry } from '@/lib/utils/retry'
import { ScenesSchema } from '@/lib/validations/schemas'
import { JobService } from '@/lib/services/job.service'

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!)

export class AIService {
  static async writeScript(projectId: string, title: string, context: string, userId: string, jobId: string) {
    
    try {
      await JobService.updateProgress(jobId, 10, 'Brainstorming script structure...');

      const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" })
      const prompt = `Write a high-retention video script for "${title}". Context: ${context}. 
                      Return a JSON array of scenes with: sequence_order, audio_text, visual_description.`

      // AI Call with Retry
      const result = await withRetry(async () => {
        const aiResponse = await model.generateContent(prompt)
        return aiResponse.response.text()
      });

      await JobService.updateProgress(jobId, 50, 'Validating and formatting scenes...');

      // Schema Validation
      const rawJson = JSON.parse(result.replace(/```json|```/g, "").trim());
      const validatedScenes = ScenesSchema.parse(rawJson);

      // Batch Save
      const scenesToInsert = validatedScenes.map(scene => ({
        ...scene,
        project_id: projectId
      }));

      // Use Admin Client to bypass RLS for writing
      await supabaseAdmin.from('scenes').delete().eq('project_id', projectId);
      await supabaseAdmin.from('scenes').insert(scenesToInsert);

      await JobService.updateProgress(jobId, 100, 'Script generation complete.');

    } catch (error: any) {
      await JobService.failJob(jobId, error.message);
      throw error; // Re-throw to be caught by the route handler log
    }
  }
}


=== FILE: lib\services\asset.service.ts ===
import { supabaseAdmin } from '../supabaseServer'

export class AssetService {
  
  /**
   * Selects an asset for a scene (Mutually Exclusive)
   */
  static async selectAsset(sceneId: string, assetId: string) {
    // 1. Unselect ALL assets for this scene
    await supabaseAdmin
      .from('scene_assets')
      .update({ is_selected: false })
      .eq('scene_id', sceneId);

    // 2. Select the target asset
    const { data, error } = await supabaseAdmin
      .from('scene_assets')
      .update({ is_selected: true })
      .eq('id', assetId)
      .select()
      .single();

    if (error) throw error;
    return data;
  }

  static async saveAssetOption(
    sceneId: string, 
    data: { 
      type: 'image' | 'video' | 'stock' | 'audio' | 'ai_image' | 'ai_video'; 
      source: string; 
      url: string;
      external_id?: string;
      prompt?: string;
    }
  ) {
     const { data: scene } = await supabaseAdmin
       .from('scenes')
       .select('project_id')
       .eq('id', sceneId)
       .single();

     if (!scene) throw new Error(`Scene ${sceneId} not found`);

     // When saving a NEW asset, check if it's the first one. If so, select it automatically.
     const { count } = await supabaseAdmin
        .from('scene_assets')
        .select('*', { count: 'exact', head: true })
        .eq('scene_id', sceneId);

     const isFirst = count === 0;

     const { data: insertedAsset, error } = await supabaseAdmin
       .from('scene_assets')
       .insert({
         project_id: scene.project_id,
         scene_id: sceneId,
         asset_type: data.type,
         asset_url: data.url,
         provider: data.source,
         prompt_used: data.prompt || null,
         status: 'ready',
         is_selected: isFirst // Auto-select if first
       })
       .select()
       .single();

     if (error) throw error;
     return insertedAsset;
  }

  static async generateAsset(projectId: string, sceneId: string, prompt: string, userId: string, userKeys: any = {}, selectedModel: string = 'mock-free') {
    console.log(`?? Generating asset for scene ${sceneId.slice(0, 5)}... Model: ${selectedModel}`);

    let assetUrl = null;
    let assetProvider = 'placeholder';

    if (selectedModel === 'mock-free') {
       assetUrl = `https://placehold.co/800x450/2a2a2a/FFF.png?text=MOCK+VISUAL+FOR+SCENE`;
       assetProvider = 'mock_free';
    }

    if (assetUrl) {
      // Auto-select logic for generated assets
      const { count } = await supabaseAdmin
        .from('scene_assets')
        .select('*', { count: 'exact', head: true })
        .eq('scene_id', sceneId);

      const { data, error } = await supabaseAdmin
        .from('scene_assets')
        .insert({
          project_id: projectId,
          scene_id: sceneId,
          asset_type: 'image',
          asset_url: assetUrl,
          provider: assetProvider,
          prompt_used: prompt,
          status: 'ready',
          is_selected: count === 0
        })
        .select()
        .single();

      if (error) throw error;
      return data;
    } else {
        return null;
    }
  }
}


=== FILE: lib\services\audio.service.ts ===
import { supabaseAdmin } from '../supabaseServer'

export class AudioService {
  
  /**
   * Main Generator (Used by API)
   */
  static async generateAudio(projectId: string, sceneId: string, text: string, userId: string, userKeys: any = {}, selectedModel: string = 'mock-free') {
    console.log(`??? Generating audio for scene ${sceneId.slice(0, 5)}... Model: ${selectedModel}`);

    let assetUrl = null;
    let assetProvider = 'placeholder';

    // --- CASE 1: Mock / Free Mode ---
    if (selectedModel === 'mock-free' || !userKeys?.elevenlabs) {
       assetUrl = `https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3`; 
       assetProvider = 'mock_audio';
    }

    if (assetUrl) {
      // Cleanup old audio
      await supabaseAdmin.from('scene_assets').delete().eq('scene_id', sceneId).eq('asset_type', 'audio');

      const { data, error } = await supabaseAdmin
        .from('scene_assets')
        .insert({
          project_id: projectId,
          scene_id: sceneId,
          asset_type: 'audio',
          asset_url: assetUrl,
          provider: assetProvider,
          status: 'ready',
          is_selected: true
        })
        .select()
        .single();

      if (error) throw error;
      return data;
    }
    return null;
  }

  /**
   * Compatibility Alias (Fixed Type Error)
   */
  static async generateVoiceover(sceneId: string, text: string) {
    console.log('?? Using compatibility alias: generateVoiceover');
    
    // 1. Fetch scene and project info
    const { data: scene } = await supabaseAdmin
      .from('scenes')
      .select('project_id, project:projects(user_id)')
      .eq('id', sceneId)
      .single();

    if (!scene) throw new Error(`Scene ${sceneId} not found`);

    // --- FIX: Handle if project is returned as an array or object ---
    const projectData = scene.project;
    // @ts-ignore
    const userId = Array.isArray(projectData) ? projectData[0].user_id : projectData.user_id;

    // 2. Call main function
    return this.generateAudio(
      scene.project_id, 
      sceneId, 
      text, 
      userId, 
      {}, 
      'mock-free'
    );
  }
}


=== FILE: lib\services\batch.service.ts ===
import { supabaseAdmin } from '@/lib/supabaseServer'
import { JobService } from '@/lib/services/job.service'
import { AssetService } from '@/lib/services/asset.service'
import { MediaService } from '@/lib/services/media.service'
import { AudioService } from '@/lib/services/audio.service'

export class BatchService {
  
  // --- VISUAL BATCH (Existing) ---
  static async processAllScenes(projectId: string, userId: string) {
    const jobId = await JobService.createJob(userId, 'asset_batch');

    (async () => {
      try {
        await JobService.updateProgress(jobId, 0, 'Starting visual generation...');
        const { data: scenes } = await supabaseAdmin
          .from('scenes')
          .select('*')
          .eq('project_id', projectId)
          .order('sequence_order', { ascending: true });

        if (!scenes || scenes.length === 0) throw new Error('No scenes found.');

        for (let i = 0; i < scenes.length; i++) {
          const scene = scenes[i];
          const progress = Math.round(((i + 1) / scenes.length) * 100);
          await JobService.updateProgress(jobId, progress, `Visuals for scene ${i + 1}...`);

          let assetData;
          if (i % 2 === 0) {
             assetData = await MediaService.searchStockVideo(scene.visual_description);
          } else {
             assetData = await MediaService.generateAIImage(scene.visual_description);
          }
          const safeData = assetData as any;

          await AssetService.saveAssetOption(scene.id, {
            type: safeData.type,
            source: safeData.source,
            url: safeData.url,
            external_id: safeData.external_id,
            prompt: safeData.prompt
          });
          await new Promise(r => setTimeout(r, 500));
        }
        await JobService.updateProgress(jobId, 100, 'Visuals complete.');
      } catch (error: any) {
        await JobService.failJob(jobId, error.message);
      }
    })();
    return jobId;
  }

  // --- AUDIO BATCH (New) ---
  static async processAudioBatch(projectId: string, userId: string) {
    const jobId = await JobService.createJob(userId, 'audio_gen');

    (async () => {
      try {
        await JobService.updateProgress(jobId, 0, 'Starting audio generation...');

        const { data: scenes } = await supabaseAdmin
          .from('scenes')
          .select('*')
          .eq('project_id', projectId)
          .order('sequence_order', { ascending: true });

        if (!scenes || scenes.length === 0) throw new Error('No scenes found.');

        for (let i = 0; i < scenes.length; i++) {
          const scene = scenes[i];
          const progress = Math.round(((i + 1) / scenes.length) * 100);
          
          await JobService.updateProgress(jobId, progress, `Generating voice for Scene ${scene.sequence_order}...`);

          // Call our new Audio Service
          if (scene.audio_text) {
             await AudioService.generateVoiceover(scene.id, scene.audio_text);
          }
          
          // Tiny delay to be nice to the free API
          await new Promise(r => setTimeout(r, 300));
        }

        await JobService.updateProgress(jobId, 100, 'Audio generation complete.');

      } catch (error: any) {
        console.error('Audio Batch Failed:', error);
        await JobService.failJob(jobId, error.message);
      }
    })();

    return jobId;
  }
}


=== FILE: lib\services\cost.service.ts ===
import { supabase } from '@/lib/supabaseClient'

export class CostService {
  // Pricing constants (Example rates for Gemini/Imagen)
  static readonly RATES = {
    GEMINI_SCRIPT: 0.01, // Flat rate per script gen
    IMAGEN_IMAGE: 0.04,  // Per AI image
    STOCK_SEARCH: 0.002, // API cost per search
    TTS_VOICEOVER: 0.005  // Per 100 characters
  }

  static async estimateProjectCost(projectId: string) {
    const { data: scenes } = await supabase
      .from('scenes')
      .select('asset_type, audio_text')
      .eq('project_id', projectId)

    if (!scenes) return 0

    let total = this.RATES.GEMINI_SCRIPT

    scenes.forEach(scene => {
      if (scene.asset_type === 'ai_image') total += this.RATES.IMAGEN_IMAGE
      if (scene.audio_text) total += (scene.audio_text.length / 100) * this.RATES.TTS_VOICEOVER
    })

    return parseFloat(total.toFixed(4))
  }

  static async logActualCost(projectId: string, userId: string, service: string, amount: number) {
    await supabase.from('costs').insert({
      project_id: projectId,
      user_id: userId,
      service: service,
      amount: amount
    })
  }
}


=== FILE: lib\services\dna.service.ts ===
import { supabase } from '@/lib/supabaseClient'

export class DNAService {
  static async getProfile(profileId: string) {
    const { data, error } = await supabase
      .from('channel_profiles')
      .select('*')
      .eq('id', profileId)
      .single()
    
    if (error) return null
    return data
  }

  static async listProfiles(userId: string) {
    const { data } = await supabase
      .from('channel_profiles')
      .select('*')
      .eq('user_id', userId)
    return data || []
  }
}


=== FILE: lib\services\job.service.ts ===
import { supabaseAdmin } from '@/lib/supabaseServer'
import { Job } from '@/lib/types'

export class JobService {
  static async createJob(userId: string, type: Job['type']): Promise<string> {
    const { data, error } = await supabaseAdmin
      .from('jobs')
      .insert({
        user_id: userId,
        type,
        status: 'pending',
        progress: 0,
        message: 'Job initialized...'
      })
      .select('id')
      .single()

    if (error) throw new Error(`Failed to create job: ${error.message}`)
    return data.id
  }

  static async updateProgress(jobId: string, progress: number, message: string) {
    await supabaseAdmin
      .from('jobs')
      .update({
        progress,
        message,
        status: progress === 100 ? 'completed' : 'running',
        updated_at: new Date().toISOString()
      })
      .eq('id', jobId)
  }

  static async failJob(jobId: string, error: string) {
    await supabaseAdmin
      .from('jobs')
      .update({
        status: 'failed',
        error,
        updated_at: new Date().toISOString()
      })
      .eq('id', jobId)
  }
}


=== FILE: lib\services\marketing.service.ts ===
import { supabaseAdmin } from '../supabaseServer'

export class MarketingService {
  
  static async generateMetadata(projectId: string) {
    // 1. Fetch Project & Script
    const { data: project } = await supabaseAdmin
      .from('projects')
      .select('*')
      .eq('id', projectId)
      .single();

    if (!project) throw new Error('Project not found');

    // 2. Generate "Smart" Mock Data (Free)
    // In production, you would replace this with an OpenAI call:
    // const prompt = `Write 5 viral titles for a video about ${project.title}...`;
    
    const baseTitle = project.title || 'Untitled Video';
    
    const marketingPackage = {
      titles: [
        `Why ${baseTitle} is Changing Everything`,
        `The Truth About ${baseTitle} (Explained)`,
        `I Tried ${baseTitle} and Here is What Happened`,
        `Top 10 Secrets of ${baseTitle}`,
        `Don't Start ${baseTitle} Until You Watch This`
      ],
      description: `In this video, we dive deep into ${baseTitle}. \n\nWe cover everything you need to know about the topic, including key insights and hidden details that most people miss. Whether you are a beginner or an expert, this breakdown of ${baseTitle} will give you a fresh perspective.\n\nDon't forget to LIKE and SUBSCRIBE for more content about ${baseTitle}!`,
      tags: [
        `#${baseTitle.replace(/\s+/g, '')}`,
        '#ViralVideo',
        '#Trending',
        '#Explained',
        '#DeepDive',
        '#Review',
        '#HowTo',
        '#Guide',
        '#2026Trends',
        '#MustWatch'
      ]
    };

    // 3. Save to Database
    const { error } = await supabaseAdmin
      .from('projects')
      .update({ marketing_data: marketingPackage })
      .eq('id', projectId);

    if (error) throw error;

    return marketingPackage;
  }
}


=== FILE: lib\services\media.service.ts ===
import { supabase } from '@/lib/supabaseClient'

export class MediaService {
  
  // --- Phase 1: UI Methods (Client-Side) ---

  /**
   * Called by MediaModal to save a manually selected asset.
   * Updates BOTH the legacy scene column and the new relational table.
   */
  static async attachAssetToScene(sceneId: string, url: string, source: string) {
    try {
      console.log(`Attaching asset to scene ${sceneId}: ${url}`);

      // 1. Legacy Update (Quick UI Feedback)
      const { error: sceneError } = await supabase
        .from('scenes')
        .update({ 
          asset_url: url,
          asset_type: url.includes('.mp4') ? 'video' : 'image'
        })
        .eq('id', sceneId);

      if (sceneError) throw sceneError;

      // 2. Future-Proof Update (Add to Version History)
      // We check if this asset already exists in the history to avoid duplicates
      const { data: existing } = await supabase
        .from('scene_assets')
        .select('id')
        .eq('scene_id', sceneId)
        .eq('url', url)
        .single();

      if (!existing) {
        await supabase.from('scene_assets').insert({
          scene_id: sceneId,
          type: url.includes('.mp4') ? 'stock' : 'ai_image',
          source: source as any,
          url: url,
          is_selected: true // Manually picked = Auto selected
        });

        // Ensure other assets for this scene are unselected
        await supabase
          .from('scene_assets')
          .update({ is_selected: false })
          .eq('scene_id', sceneId)
          .neq('url', url);
      }

      return true;
    } catch (error) {
      console.error('Failed to attach asset:', error);
      return false;
    }
  }

  static async searchPexels(query: string) {
    console.log(`UI Searching Pexels for: ${query}`);
    return Array.from({ length: 6 }).map((_, i) => ({
      id: `pexels-${Date.now()}-${i}`,
      type: i % 2 === 0 ? 'image' : 'video',
      source: 'pexels',
      url: i % 2 === 0 
        ? 'https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1'
        : 'https://files.vidstack.io/sprite-fight/720p.mp4',
      thumbnail: i % 2 === 0 
        ? 'https://images.pexels.com/photos/1108099/pexels-photo-1108099.jpeg?auto=compress&cs=tinysrgb&w=400'
        : 'https://files.vidstack.io/sprite-fight/poster.webp',
      alt: `Result for ${query}`
    }));
  }

  static async searchUnsplash(query: string) { return []; }
  static async searchPixabay(query: string) { return []; }

  // --- Phase 2: Batch/AI Methods (Server-Side Compatible) ---
  
  static async searchStockVideo(query: string) {
    return {
      type: 'stock',
      source: 'pexels',
      url: 'https://files.vidstack.io/sprite-fight/720p.mp4', 
      external_id: 'vid_' + Date.now()
    };
  }

  static async generateAIImage(prompt: string) {
    return {
      type: 'ai_image',
      source: 'imagen',
      url: 'https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?w=800&q=80',
      prompt: prompt
    };
  }
}


=== FILE: lib\services\project.service.ts ===
// Changed to relative import for compatibility with local test scripts
import { supabaseAdmin } from '../supabaseServer'

export class ProjectService {
  static async exportProjectPackage(projectId: string) {
    const { data: project, error: projError } = await supabaseAdmin
      .from('projects')
      .select('*')
      .eq('id', projectId)
      .single()
    
    if (projError || !project) throw new Error('Project not found')

    const { data: scenes, error: sceneError } = await supabaseAdmin
      .from('scenes')
      .select('*, scene_assets!inner(*)')
      .eq('project_id', projectId)
      .eq('scene_assets.is_selected', true)
      .order('sequence_order', { ascending: true })

    if (sceneError) throw new Error(`Failed to fetch scenes: ${sceneError.message}`)

    const exportPackage = {
      version: '1.0',
      project: {
        id: project.id,
        title: project.title,
        created_at: project.created_at,
        stats: {
          scene_count: scenes?.length || 0,
          estimated_duration: (scenes?.length || 0) * 5
        }
      },
      timeline: scenes?.map(scene => ({
        sequence: scene.sequence_order,
        narration: {
          text: scene.audio_text,
        },
        visual: {
          description: scene.visual_description,
          asset_url: scene.scene_assets[0]?.url,
          asset_type: scene.scene_assets[0]?.type,
          source: scene.scene_assets[0]?.source
        }
      }))
    }

    return exportPackage
  }
}


=== FILE: lib\services\script.service.ts ===
import { supabaseAdmin } from '../supabaseServer'
import { GoogleGenerativeAI } from '@google/generative-ai'
import OpenAI from 'openai'

export class ScriptService {
  static async generateScript(projectId: string, title: string, context: string, userKeys: any = {}, selectedModel: string = 'mock-free') {
    console.log(`?? Script Gen Start. Model: ${selectedModel}`);
    
    let scenes = [];

    // --- CASE 1: OpenAI Selected ---
    // Safe check: ensure userKeys exists AND has openai property
    if (selectedModel?.startsWith('gpt') && userKeys?.openai) {
      try {
        console.log('?? Using OpenAI...');
        const openai = new OpenAI({ apiKey: userKeys.openai });
        const completion = await openai.chat.completions.create({
          messages: [
            { role: "system", content: "You are a viral video script writer. Generate a JSON response with an array of 5 scenes. Each scene must have 'visual_description' (for AI image gen) and 'audio_text' (for voiceover)." },
            { role: "user", content: `Title: ${title}. Context: ${context}` }
          ],
          model: selectedModel,
          response_format: { type: "json_object" },
        });
        const content = completion.choices[0].message.content;
        if (content) scenes = JSON.parse(content).scenes || [];
      } catch (e) { console.warn('?? OpenAI failed, falling back:', e); }
    }

    // --- CASE 2: Gemini Selected ---
    else if (selectedModel?.startsWith('gemini') && userKeys?.gemini) {
      try {
        console.log('? Using Gemini...');
        const genAI = new GoogleGenerativeAI(userKeys.gemini);
        const model = genAI.getGenerativeModel({ model: "gemini-pro" });
        const prompt = `Generate a JSON object with a "scenes" array (5 items) for a video titled "${title}". Each scene needs "visual_description" and "audio_text". Return ONLY JSON.`;
        
        const result = await model.generateContent(prompt);
        const text = result.response.text().replace(/```json/g, '').replace(/```/g, '').trim();
        scenes = JSON.parse(text).scenes || [];
      } catch (e) { console.warn('?? Gemini failed, falling back:', e); }
    }

    // --- CASE 3: Free/Mock (Default or Fallback) ---
    // This runs if NO SCENES were generated above (due to error or missing key)
    if (!scenes || scenes.length === 0) {
      console.log('?? Using Mock / Free Path');
      scenes = [
        { sequence_order: 1, visual_description: "High contrast cinematic hook", audio_text: `Stop scrolling. You won't believe the truth about ${title}.` },
        { sequence_order: 2, visual_description: "Fast paced archival montage", audio_text: "For years we were told one story, but new evidence changes everything." },
        { sequence_order: 3, visual_description: "Split screen comparison", audio_text: "Here is the detail everyone missed." },
        { sequence_order: 4, visual_description: "3D animated breakdown", audio_text: "When you analyze the data, the math proves the opposite." },
        { sequence_order: 5, visual_description: "Host walking into light", audio_text: "Subscribe for more insights like this." }
      ];
    }

    // Save to Database
    const { error } = await supabaseAdmin
      .from('scenes')
      .insert(scenes.map((s: any, i: number) => ({
        project_id: projectId,
        sequence_order: i + 1,
        visual_description: s.visual_description,
        audio_text: s.audio_text,
        status: 'draft'
      })));

    if (error) {
        console.error('Supabase Write Error:', error);
        throw error;
    }
    return scenes;
  }
}


=== FILE: lib\types\index.ts ===
export type ProjectStatus = 'draft' | 'processing' | 'completed' | 'failed';

export interface Project {
  id: string;
  user_id: string;
  title: string;
  description?: string;
  status: ProjectStatus;
  metadata: any;
  created_at: string;
}

export type AssetType = 'stock' | 'ai_image' | 'uploaded';
export type AssetSource = 'pexels' | 'pixabay' | 'unsplash' | 'imagen' | 'gemini' | 'user';

export interface SceneAsset {
  id: string;
  scene_id: string;
  type: AssetType;
  source: AssetSource;
  external_id?: string;
  url: string;
  prompt?: string;
  is_selected: boolean;
  created_at: string;
}

export interface Scene {
  id: string;
  project_id: string;
  sequence_order: number;
  audio_text: string;
  visual_description: string;
  // The new asset array
  assets?: SceneAsset[];
  // Helper for the UI
  selected_asset_url?: string; 
}

export interface Job {
  id: string;
  user_id: string;
  type: 'script_gen' | 'asset_batch' | 'audio_gen';
  status: 'pending' | 'running' | 'completed' | 'failed';
  progress: number;
  message: string;
  result?: any;
  error?: string;
}

export interface CostRecord {
  id: string;
  project_id: string;
  user_id: string;
  service: string;
  amount: number;
  created_at: string;
}


=== FILE: lib\utils\retry.ts ===
export async function withRetry<T>(fn: () => Promise<T>, retries = 3, delay = 2000): Promise<T> {
  for (let i = 0; i < retries; i++) {
    try {
      return await fn();
    } catch (e) {
      if (i === retries - 1) throw e;
      console.warn(`Attempt ${i + 1} failed, retrying in ${delay}ms...`);
      await new Promise(r => setTimeout(r, delay * Math.pow(2, i))); // Exponential backoff
    }
  }
  throw new Error("Retry logic failed");
}


=== FILE: lib\validations\schemas.ts ===
import { z } from 'zod'

export const SceneSchema = z.object({
  sequence_order: z.number(),
  audio_text: z.string(),
  visual_description: z.string()
})

export const ScenesSchema = z.array(SceneSchema)

export type ValidatedScene = z.infer<typeof SceneSchema>


=== FILE: lib\pillarStatus.ts ===
export type PillarStatus = 'Not Started' | 'In Progress' | 'Complete' | 'Coming Soon';

export const getIdeateStatus = (project: any): PillarStatus => {
  if (project.title && project.title.length > 0) {
    return 'Complete';
  }
  return 'Not Started';
};

export const getWriteStatus = (project: any): PillarStatus => {
  if (project.content && project.content.length > 0) {
    return 'Complete';
  }
  return 'Not Started';
};

export const getVisualizeStatus = (project: any): PillarStatus => {
  if (project.scenes && project.scenes.length > 0) {
    const allScenesHaveAssets = project.scenes.every((scene: any) => scene.assets && scene.assets.length > 0);
    if (allScenesHaveAssets) {
      return 'Complete';
    }
    const someScenesHaveAssets = project.scenes.some((scene: any) => scene.assets && scene.assets.length > 0);
    if (someScenesHaveAssets) {
        return 'In Progress';
    }
  }
  return 'Not Started';
};

export const getLaunchStatus = (): PillarStatus => {
  return 'Coming Soon';
};


=== FILE: lib\supabaseClient.ts ===
import { createBrowserClient } from '@supabase/ssr'

export const createClient = () =>
  createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )

// Export a singleton for simple use-cases
export const supabase = createClient()


=== FILE: lib\supabaseServer.ts ===
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!

// Use only in API routes/Server Actions. Never expose to client.
export const supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})


=== FILE: lib\types.ts ===
export interface SceneAsset {
  id: string;
  project_id: string;
  scene_id: string;
  asset_type: 'image' | 'video' | 'stock' | 'audio' | 'ai_image' | 'ai_video';
  asset_url: string;
  provider: string; 
  status: string;
  created_at: string;
  prompt_used?: string;
  is_selected: boolean; // Added this field
}

export interface Scene {
  id: string;
  project_id: string;
  sequence_order: number;
  visual_description: string;
  audio_text: string;
  status: string;
  scene_assets?: SceneAsset[]; 
}

export interface Project {
  id: string;
  user_id: string;
  title: string;
  description?: string;
  status: 'draft' | 'processing' | 'completed';
  created_at: string;
  marketing_data?: any;
}

export interface Job {
  id: string;
  user_id: string;
  type: 'script_gen' | 'asset_batch' | 'audio_gen';
  status: 'pending' | 'processing' | 'completed' | 'failed';
  progress: number;
  message?: string;
  created_at: string;
  updated_at: string;
}


=== FILE: scripts\test-asset-engine.ts ===
import { supabaseAdmin } from '@/lib/supabaseServer';
import { BatchService } from '@/lib/services/batch.service';
import { AssetService } from '@/lib/services/asset.service';

async function runSmokeTest() {
  console.log('ðŸ”¥ Starting Smoke Test for Asset Engine...');

  try {
    // 1. Setup: Create a dummy project and scene
    const { data: user } = await supabaseAdmin.auth.admin.listUsers();
    const testUserId = user.users[0]?.id; // Grab the first user for testing

    if (!testUserId) throw new Error('No users found in database to test with.');

    console.log(`ðŸ‘¤ Testing as User: ${testUserId}`);

    const { data: project } = await supabaseAdmin.from('projects').insert({
      user_id: testUserId,
      title: 'Smoke Test Project',
      status: 'draft'
    }).select().single();

    const { data: scene } = await supabaseAdmin.from('scenes').insert({
      project_id: project.id,
      sequence_order: 1,
      audio_text: 'Test audio',
      visual_description: 'A futuristic city with flying cars'
    }).select().single();

    console.log(`âœ… Setup Complete. Project: ${project.id}, Scene: ${scene.id}`);

    // 2. Test Asset Service (Save Option)
    console.log('ðŸ§ª Testing AssetService.saveAssetOption...');
    const asset1 = await AssetService.saveAssetOption(scene.id, {
      type: 'stock',
      source: 'pexels',
      url: 'http://test.com/video1.mp4'
    });
    
    if (asset1.is_selected !== true) throw new Error('First asset was not auto-selected!');
    console.log('   -> Asset 1 saved and auto-selected.');

    const asset2 = await AssetService.saveAssetOption(scene.id, {
      type: 'ai_image',
      source: 'imagen',
      url: 'http://test.com/image1.png'
    });

    if (asset2.is_selected === true) throw new Error('Second asset should NOT be selected by default.');
    console.log('   -> Asset 2 saved as option.');

    // 3. Test Selection Logic
    console.log('ðŸ§ª Testing AssetService.selectAsset...');
    await AssetService.selectAsset(scene.id, asset2.id);
    
    const { data: updatedAsset1 } = await supabaseAdmin.from('scene_assets').select().eq('id', asset1.id).single();
    const { data: updatedAsset2 } = await supabaseAdmin.from('scene_assets').select().eq('id', asset2.id).single();

    if (updatedAsset1.is_selected) throw new Error('Asset 1 failed to unselect');
    if (!updatedAsset2.is_selected) throw new Error('Asset 2 failed to select');
    console.log('   -> Selection logic verified.');

    // 4. Test Batch Service (Job Creation)
    console.log('ðŸ§ª Testing BatchService.processAllScenes...');
    const jobId = await BatchService.processAllScenes(project.id, testUserId);
    console.log(`   -> Batch Job triggered. ID: ${jobId}`);

    // Cleanup
    console.log('ðŸ§¹ Cleaning up test data...');
    await supabaseAdmin.from('projects').delete().eq('id', project.id);
    
    console.log('ðŸŽ‰ TEST PASSED: Asset Engine is fully operational.');

  } catch (error) {
    console.error('âŒ TEST FAILED:', error);
    process.exit(1);
  }
}

runSmokeTest();


=== FILE: scripts\test-audio.ts ===
// Force load env vars for local testing
// Renamed 'path' to 'nodePath' to avoid conflict
const nodePath = require('path');
require('dotenv').config({ path: nodePath.resolve(__dirname, '../.env.local') });

// Renamed imports to avoid conflicts with test-export.ts
const { supabaseAdmin: audioSupabase } = require('../lib/supabaseServer');
const { AudioService: AudioSvc } = require('../lib/services/audio.service');

async function testAudioPipeline() {
  console.log('?? Starting Audio Pipeline Test...');

  try {
    // 1. Setup: Get a user 
    const { data: user } = await audioSupabase.auth.admin.listUsers();
    
    // Fallback ID if no users exist locally
    const testUserId = user.users[0]?.id || '00000000-0000-0000-0000-000000000000';

    console.log('   -> Creating temp resources...');
    const { data: project } = await audioSupabase.from('projects').insert({
      user_id: testUserId,
      title: 'Audio Test Project',
      status: 'draft'
    }).select().single();

    const { data: scene } = await audioSupabase.from('scenes').insert({
      project_id: project.id,
      sequence_order: 1,
      audio_text: 'Welcome to your new AI Creator Studio. This voice was generated for free.',
      visual_description: 'Test'
    }).select().single();

    // 2. Run the Service
    console.log('?? Calling AudioService.generateVoiceover...');
    const publicUrl = await AudioSvc.generateVoiceover(scene.id, scene.audio_text);

    // 3. Validation
    if (!publicUrl.includes('project-assets')) throw new Error('Returned URL does not point to Supabase Storage');
    
    console.log('? AUDIO SUCCESS! File stored at:');
    console.log(publicUrl);

    // 4. Cleanup
    console.log('?? Cleaning up DB records...');
    await audioSupabase.from('projects').delete().eq('id', project.id);

  } catch (error) {
    console.error('? AUDIO TEST FAILED:', error);
    process.exit(1);
  }
}

testAudioPipeline();


=== FILE: scripts\test-export.ts ===
// 1. Force load the Next.js environment variables
// This fixes the "supabaseUrl is required" error
const path = require('path');
require('dotenv').config({ path: path.resolve(__dirname, '../.env.local') });

// 2. Import Services
const { supabaseAdmin } = require('../lib/supabaseServer');
const { ProjectService } = require('../lib/services/project.service');
const { AssetService } = require('../lib/services/asset.service');

async function testExportEngine() {
  console.log('?? Starting Local Export Test...');

  try {
    // 3. Setup: Create Dummy Data
    const { data: user } = await supabaseAdmin.auth.admin.listUsers();
    
    // Fallback: If no users exist, create a fake ID (RLS is bypassed by Admin client anyway)
    const testUserId = user.users[0]?.id || '00000000-0000-0000-0000-000000000000';
    console.log(`   -> Testing with User ID: ${testUserId}`);

    console.log('   -> Creating test project...');
    const { data: project, error: projError } = await supabaseAdmin.from('projects').insert({
      user_id: testUserId,
      title: 'Export Test Project',
      status: 'draft'
    }).select().single();

    if (projError) throw new Error(`Project creation failed: ${projError.message}`);

    console.log('   -> Creating test scene...');
    const { data: scene, error: sceneError } = await supabaseAdmin.from('scenes').insert({
      project_id: project.id,
      sequence_order: 1,
      audio_text: 'Hello World',
      visual_description: 'Test visual'
    }).select().single();

    if (sceneError) throw new Error(`Scene creation failed: ${sceneError.message}`);

    console.log('   -> Adding and selecting asset...');
    await AssetService.saveAssetOption(scene.id, {
      type: 'stock',
      source: 'pexels',
      url: 'https://test.com/video.mp4'
    });

    // 4. Test the Export Logic
    console.log('?? Running ProjectService.exportProjectPackage...');
    const result = await ProjectService.exportProjectPackage(project.id);

    // 5. Validate Output
    if (result.project.title !== 'Export Test Project') throw new Error('Title mismatch');
    if (result.timeline.length !== 1) throw new Error('Timeline length mismatch');
    if (result.timeline[0].visual.asset_url !== 'https://test.com/video.mp4') throw new Error('Asset URL mismatch');

    console.log('? EXPORT SUCCESS! Payload structure:');
    console.log(JSON.stringify(result, null, 2));

    // 6. Cleanup
    console.log('?? Cleaning up...');
    await supabaseAdmin.from('projects').delete().eq('id', project.id);

  } catch (error) {
    console.error('? EXPORT TEST FAILED:', error);
    process.exit(1);
  }
}

testExportEngine();


=== FILE: types\google-tts-api.d.ts ===
declare module 'google-tts-api' {
  interface TTSOptions {
    lang?: string;
    slow?: boolean;
    host?: string;
    timeout?: number;
  }

  export function getAudioUrl(text: string, options?: TTSOptions): string;
  export function getAllAudioUrls(text: string, options?: TTSOptions): { url: string; shortText: string }[];
}


=== FILE: next-env.d.ts ===
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.


=== FILE: next.config.ts ===
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;


=== FILE: package.json ===
{
  "name": "creator-studio-web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@google/generative-ai": "^0.24.1",
    "@supabase/auth-ui-react": "^0.4.7",
    "@supabase/auth-ui-shared": "^0.1.8",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.95.3",
    "google-tts-api": "^0.0.6",
    "jszip": "^3.10.1",
    "lucide-react": "^0.563.0",
    "next": "16.1.6",
    "openai": "^6.18.0",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "zod": "^4.3.6"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.24",
    "dotenv": "^17.2.4",
    "eslint": "^9",
    "eslint-config-next": "16.1.6",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5"
  }
}


=== FILE: README.md ===
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.


=== FILE: ROADMAP.md ===
# Project Roadmap: Creator Studio Web

## Phase 1: Core Dashboard (Completed)
- [x] Set up Next.js & Supabase
- [x] AI Script Writer (Gemini 2.5)
- [x] Basic Asset Manager (Stock Photos)
- [x] Dashboard Pillars Status (Refined Project Cards)

## Phase 2: The "Launch" Pillar (Next Up)
- [ ] **Feature:** Create "Export" page in Dashboard.
- [ ] **Feature:** Add "Generate YouTube Title/Description" button using Gemini.
- [ ] **Feature:** Add "Download All Assets" zip button.

## Phase 3: Polish
- [ ] **UI:** Add dark mode toggle.
- [ ] **Auth:** Add User Profile settings page.


=== FILE: tailwind.config.ts ===
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
    "./lib/**/*.{js,ts,jsx,tsx,mdx}", // Added lib just in case
  ],
  theme: {
    extend: {
      colors: {
        background: "var(--background)",
        foreground: "var(--foreground)",
      },
    },
  },
  plugins: [],
};
export default config;


=== FILE: tsconfig.json ===
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
